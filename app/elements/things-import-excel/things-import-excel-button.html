<!--
A comment describing this element

Example:

	<my-elem></my-elem>

Example:

	<my-elem>
	  <h2>Hello my-elem</h2>
	</my-elem>

@demo demo/index.html
-->
<link rel="import" href="../things-button/things-button.html">
<script src='shim.js'></script>
<script src='../../../bower_components/jszip/dist/jszip.min.js'></script>
<script src='../../../lib/js-xlsx/dist/ods.js'></script>
<script src='../../../lib/js-xlsx/dist/xlsx.js'></script>


<dom-module id="things-import-excel-button">
	<template>
		<things-button color="green" id="import-btn" on-click="_importClick">Import</things-button>
		<input type="file" id="fileInput" on-change="_handleFile" hidden multiple="{{multi}}" accept="{{accept}}">
	</template>
	<script>
		Polymer({
			is: 'things-import-excel-button',
			//Properties
			properties: {
				/**
				 * handel excel as json/formulae/csv
				 * defualt uses json
				 */
				handleAs:{
					type:String,
					value:'json'
				},
				excel:{
					type : Object,
					value: XLSX,
					readonly:true
				},
				excelWorker: {
					type: Object,
					readonly: true,
					value: {
						/* worker message */
						msg: 'xlsx',
						/* worker scripts */
						rABS: './xlsxworker2.js',
						norABS: './xlsxworker1.js',
						noxfer: './xlsxworker.js'
					}
				},
				parsedResult:{
					type:Object,
					notify:true
				},
				sheetName:{
					type:String
				}
				// /**
				//  * root property of loaded data
				//  * @type String
				//  */
				// rootProperty: {
				// 	type: String,
				// 	value: ''
				// },

				// /**
				//  * total count property of loaded data
				//  * @type String
				//  */
				// totalProperty: {
				// 	type: String,
				// 	value: ''
				// },
			},

			created:function(){
			},
			// Element Lifecycle
			ready: function() {},

			attached: function() {
				// console.log(this.excel);
			},

			detached: function() {},

			// Element Behavior
			behaviors: [],

			// Event listener
			listeners : {},

			_fixdata : function (data) {
				var o = "", l = 0, w = 10240;
				for(; l<data.byteLength/w; ++l) o+=String.fromCharCode.apply(null,new Uint8Array(data.slice(l*w,l*w+w)));
				o+=String.fromCharCode.apply(null, new Uint8Array(data.slice(l*w)));
				return o;
			},

			_ab2str :function (data) {
				var o = "", l = 0, w = 10240;
				for(; l<data.byteLength/w; ++l) o+=String.fromCharCode.apply(null,new Uint16Array(data.slice(l*w,l*w+w)));
				o+=String.fromCharCode.apply(null, new Uint16Array(data.slice(l*w)));
				return o;
			},

			_s2ab : function (s) {
				var b = new ArrayBuffer(s.length*2), v = new Uint16Array(b);
				for (var i=0; i != s.length; ++i) v[i] = s.charCodeAt(i);
				return [v, b];
			},
			_readAsBinaryStringAble:function(){
				return typeof FileReader !== "undefined" && typeof FileReader.prototype !== "undefined" && typeof FileReader.prototype.readAsBinaryString !== "undefined";
			},
			_webWorkerAble :function(){
				return typeof Worker !== 'undefined';
			},
			_transferable :function(){
				return typeof Worker !== 'undefined';
			},
			_excelWork : function (data, cb) {
				var transferable = this._transferable();
				if(transferable) 
					this._excelWorkXfer(data, cb);
				else 
					this._excelWorkNoxfer(data, cb);
			},
			_excelWorkNoxfer : function (data, cb) {
				var worker = new Worker(this.excelWorker.noxfer);
				var rABS = this._readAsBinaryStringAble();
				var me = this;

				worker.onmessage = function(e) {
					switch(e.data.t) {
						case 'ready': break;
						case 'e': console.error(e.data.d); break;
						case me.excelWorker.msg: cb(JSON.parse(e.data.d)); break;
					}
				};
				var arr = rABS ? data : btoa(_fixdata(data));
				worker.postMessage({d:arr,b:rABS});
			},

			_excelWorkXfer : function (data, cb) {
				var rABS = this._readAsBinaryStringAble();
				var worker = new Worker(rABS ? this.excelWorker.rABS : this.excelWorker.norABS);
				var me = this;

				worker.onmessage = function(e) {
					switch(e.data.t) {
						case 'ready': break;
						case 'e': console.error(e.data.d); break;
						default: xx= me._ab2str(e.data).replace(/\n/g,"\\n").replace(/\r/g,"\\r"); console.log("done"); cb(JSON.parse(xx)); break;
					}
				};

				if(rABS) {
					var val = this._s2ab(data);
					worker.postMessage(val[1], [val[1]]);
				} else {
					worker.postMessage(data, [data]);
				}
			},
			_toJson: function (workbook) {
				var result = {};
				var me = this;
				if(me.sheetName){
					var items = me.excel.utils.sheet_to_row_object_array(workbook.Sheets[me.sheetName]);
					var total = items.length;
					if(me.rootProperty)
					{
						result[me.rootProperty] = items;
						result[me.totalProperty] = total;
					}else{
						result = items;
					}
					return result;
				}else{
					workbook.SheetNames.forEach(function(sheetName) {
						var roa = me.excel.utils.sheet_to_row_object_array(workbook.Sheets[sheetName]);
						var total = roa.length;
						if(roa.length > 0){
							result[sheetName]={};
							if(me.rootProperty)
							{
								result[sheetName][this.rootProperty] = roa;
								result[sheetName][this.totalProperty] = total
							}else{
								result[sheetName] = roa;
							}
							// result[sheetName][this.rootProperty] = roa;
							// result[sheetName][this.totalProperty] = total
						}
					});
					return result;
				}
			},
			_toCsv : function (workbook) {
				var result = [];
				var me = this;
				var result = {};
				var me = this;
				if(me.sheetName){
					var csv = me.excel.utils.sheet_to_csv(workbook.Sheets[me.sheetName]);
					if(csv.length>0){
						result.push(csv);
					}
				}else{
					var csv = me.excel.utils.sheet_to_csv(workbook.Sheets[sheetName]);
					if(csv.length > 0){
						result.push("SHEET: " + sheetName);
						result.push("");
						result.push(csv);
					}
				}
				return result.join("\n");
			},
			_processWorkbook : function (workbook) {
				var output = "";
				switch(this.handleAs) {
					case "csv":
						output = this._toCsv(workbook);
						break;
					default:
						output = JSON.stringify(this._toJson(workbook), 2, 2);
				}
				this.parsedResult = JSON.parse(output);
				this.fire('excel-process-finish',this.parsedResult);
			},
			/**
			 * Clicks the invisible file input
			*/
			_importClick: function() {
				var elem = this.$.fileInput;
				if (elem && document.createEvent) { // sanity check
					var evt = document.createEvent('MouseEvents');
					evt.initEvent("click", true, false);
					elem.dispatchEvent(evt);
				}
			},
			_handleFile :function (e) {
				var rABS = this._readAsBinaryStringAble();
				var use_worker = this._webWorkerAble();
				var use_worker = false;
				var files = e.target.files;
				var f = files[0];
				var reader = new FileReader();
				var name = f.name;
				var me = this;
				reader.onload = function(e) {
					// if(typeof console !== 'undefined') 
					// 	console.log("onload", new Date(), rABS, use_worker);

					var data = e.target.result;
					if(use_worker) {
						me._excelWork(data, this._processWorkbook);
					} else {
						var wb;
						if(rABS) {
							wb = me.excel.read(data, {type: 'binary'});
						} else {
						var arr = _fixdata(data);
							wb = me.excel.read(btoa(arr), {type: 'base64'});
						}
						me._processWorkbook(wb);
					}
				};
				if(rABS) reader.readAsBinaryString(f);
				else reader.readAsArrayBuffer(f);
			}

		});
	</script>
</dom-module>