<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../../bower_components/iron-form/iron-form.html">
<link rel="import" href="../../../bower_components/iron-input/iron-input.html">
<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/iron-iconset/iron-iconset.html">
<link rel="import" href="../../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">

<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../../bower_components/paper-fullscreen-dialog/paper-fullscreen-dialog.html">
<link rel="import" href="../../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../../../bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="../../../bower_components/paper-tooltip/paper-tooltip.html">

<link rel="import" href="./things-std-form-behavior.html">

<!--
Resource Form Element. 

설정한 form-fields를 바탕으로 리소스 폼을 생성해주고 설정한 resource-url로 데이터를 조회/수정한다.

form-fields는 Form의 child element들을 구성하기 위한 meta data이고 field 명, 표시를 위한 label, element(view) type 그리고 element view가 추가로 필요한 attribute로 구성된다. form-fields는 다음과 같은 형식으로 설정하거나 서버로 부터 조회한다.

	Form Fields Example:

		[ {
		  "name" : "id",
		  "label" : "ID",
		  "type" : "number"
		}, {
		  "name" : "name",
		  "label" : "Name",
		  "type" : "text"
		}, {
		  "name" : "display",
		  "label" : "Display",
		  "type" : "text"
		}, {
		  "name" : "description",
		  "label" : "Description",
		  "type" : "text"
		}, {
		  "name" : "locale",
		  "label" : "Locale",
		  "type" : "code-combo",
		  "codeName" : "LOCALE"
		}, {
		  "name" : "category",
		  "label" : "Category",
		  "type" : "code-combo",
		  "codeName" : "TERMS_CATEGORY"
		}, {
		  "name" : "creator_id",
		  "label" : "Created By",
		  "type" : "text"
		}, {
		  "name" : "updater_id",
		  "label" : "Updated By",
		  "type" : "text"
		}, {
		  "name" : "created_at",
		  "label" : "Created At",
		  "type" : "text"
		}, {
		  "name" : "updated_at",
		  "label" : "Updated At",
		  "type" : "text"
		} ]

아래 Example은 서버로 부터 form-fields meta data를 조회해서 동적으로 리소스 폼을 구성하는 샘플이다.
things-resource로 부터 위와 같은 형식의 form-fields meta data를 조회하여 things-std-resource-form으로 바인딩한다.

폼 데이터를 조회할 때는 url : terminologies/:id, method : get 으로,
폼 데이터를 업데이트할 때는  url : terminologies/:id, method : put 으로 한다.
업데이트 후에는 last-response로 결과를 얻을 수 있다.

폼이 오픈될 때 things-std-resource-form-opened 이벤트가 발생하고 
조회 things-std-resource-form-read 이벤트가, 업데이트 성공시 things-std-resource-form-saved 에러 발생시 things-std-resource-form-error가 발생되므로 성공/실패시 custom action을 구성할 수 있다.

	Resource Form Example:

    <things-resource 
      auto
      action="diy_services/ElidomResourceFormFields/query.json" 
      last-response="{{formFields}}">
    </things-resource>

    <things-std-resource-form 
      id="resource-form"
      title="Item Detail"
      form-fields="[[formFields]]" 
      resource-url="terminologies/:id"
      last-response="{{lastResponse}}">
    </things-std-resource-form>


@demo ./things-form/demo/demo-things-std-resource-form.html
-->

<dom-module id="things-std-resource-form">

	<template>
		<style is="custom-style" include="iron-flex iron-flex-alignment"></style>
		<style>
			:host {
				display: block;
				box-sizing: border-box;
				/*text-align: center;*/
				/*margin: 100px auto;*/
				height: 90%;
				width: 90%;
			}

			:host .resource-form {
				padding: 10px 15px 10px 15px;
			}

			:host .fields {
				padding: 10px;
			}
		</style>

		<paper-fullscreen-dialog
			id="resource-dialog"
			modal="true"
			dismiss-icon="close">

			<h2>{{title}}</h2>
			
			<paper-button affirmative dialog-confirm on-tap="saveResourceForm">Save</paper-button>
			
			<form
					is="iron-form" 
					id="resource-form" 
					action=[[action]]
					headers="[[headers]]"
					content-type="application/json"
					method="[[method]]"
					last-response="{{lastResponse}}">
				<div class="layout horizontal flex">
					<div id="left-fields" class="layout vertical flex fields"></div>
					<div id="right-fields" class="layout vertical flex fields"></div>
				</div>
			</form>
		</paper-fullscreen-dialog>

		<things-resource 
			id="member-resource"
			action="{{resourceUrl}}" 
			method="GET"
			last-response="{{resource}}">
		</things-resource>
	</template>

	<script>
		Polymer({
			is: 'things-std-resource-form',
			
			properties: {
				/**
				 * 폼 타이틀 
				 */
				title: {
					type: String
				},

				/**
				 * Resource Get/Update를 하기 위한 URL.
				 * 이 속성으로 아이디로 레코드를 조회하거나 레코드를 업데이트 혹은 생성하는데 사용된다.
				 * Resource URL은 보통 {복수 entity 명}/{:id} 형식이다. 
				 * ex) users/:id
				 */
				resourceUrl: {
					type: String
				},

				/**
				 * 폼에 채우기 위한 리소스
				 * 최초 폼이 실행되는 시점에 서버에 요청하여 리턴받은 데이터
				 */
				resource: {
					type: Object,
					observer: '_resourceChanged'
				},

				/**
				 * Save 하기 전에 폼에는 있지만 Save하는데 필요 없는 필드를 삭제하기 위한 필드명
				 */
				removeFieldsOnSave: {
					type: Array,
					value: ['creator', 'updater', 'creator_id', 'updater_id', 'created_at', 'updated_at']
				}
			},

			behaviors: [
				Things.StdFormBehavior,
				Polymer.IronResizableBehavior
			],

			/**
			 * 폼이 오픈된 후 fire
			 *
			 * @event things-std-resource-form-opened
			 */
			/**
			 * 리소스 조회 후 fire
			 *
			 * @event things-std-resource-form-read
			 */
			/**
			 * 리소스 업데이트 후 fire
			 *
			 * @event things-std-resource-form-saved
			 */
			/**
			 * 생성 후 fire
			 *
			 * @event things-std-resource-form-created
			 */
			 /**
			  * 조회/생성/업데이트 후 fire
			  *
			  * @event things-std-resource-form-error
			  */

			listeners : {
				'iron-resize': '_screenResizeHandler',
				'iron-form-presubmit' :'_preSubmitHandler',
				'member-resource.things-resource-ajax-success' : '_successResponseHandler',
				'member-resource.things-resource-ajax-error' : '_errorResponseHandler',
				'resource-dialog.iron-overlay-closed': 'clearResourceForm',
				'resource-dialog.iron-overlay-canceled': 'clearResourceForm',
				'resource-dialog.iron-overlay-opened': '_resourceFormOpenHandler'				
			},

			/**
			 * 리소스 폼 화면을 구성. formFields 정보로 동적으로 폼 하위 엘리먼트를 생성하여 폼을 구성한다. 
			 */
			reconfigureMyForm: function() {
				for(index in this.formFields) {
					var field = this.formFields[index];
					var newElement = this.createFormElement(field);

					if((index % 2) == 0) {
						this.$['left-fields'].appendChild(newElement);
					} else {
						this.$['right-fields'].appendChild(newElement);
					}
				}
			},			

			/**
			 * save data from resource detail screen
			 */
			saveResourceForm: function() {
				var resourceSaver = this.$['member-resource'];
				var originalAction = resourceSaver.action;
				var originalContentType = resourceSaver.contentType;

				if(this.resource.id) {
					resourceSaver.action = resourceSaver.action.replace(':id', this.resource.id);
					resourceSaver.method ='PUT';
				} else {
					resourceSaver.action = resourceSaver.action.replace('/:id', '');
					resourceSaver.method ='POST';
				}

				var params = this.serializeMyForm();
				params = this._filterResourceColumns(params);
				resourceSaver.params = params;
				resourceSaver.contentType = 'application/json';
				resourceSaver.generateRequest();
				resourceSaver.action = originalAction;
				resourceSaver.contentType = originalContentType;
			},

			/**
			 * 리소스 폼을 오픈한다.
			 */
			openResourceForm: function(data) {
				if(this.$['left-fields'].childNodes.length == 0) {
					this.reconfigureMyForm();
				}

				this.findResource(data.id);
				this.$['resource-dialog'].toggle();
			},

			/**
			 * 리소스 아이디로 서버에 리소스를 조회 요청한다.
			 * @param {Object} resourceId
			 */
			findResource: function(resourceId) {
				var resourceGetter = this.$['member-resource'];
				var originalAction = resourceGetter.action;
				resourceGetter.method = 'GET';
				resourceGetter.action = resourceGetter.action.replace(':id', resourceId);
				resourceGetter.generateRequest();
				resourceGetter.action = originalAction;
			},

			/**
			 * 리소스 폼 내부의 모든 엘리먼트들을 클리어한다.
			 */
			clearResourceForm: function(event) {
				if(event.srcElement.id == 'resource-dialog') {
					while(this.$['left-fields'].childNodes.length > 0 || this.$['right-fields'].childNodes.length > 0) {
						if(this.$['left-fields'].childNodes[0]) {
							this.$['left-fields'].removeChild(this.$['left-fields'].childNodes[0]);
						}

						if(this.$['right-fields'].childNodes[0]) {
							this.$['right-fields'].removeChild(this.$['right-fields'].childNodes[0]);
						}
					}
				}
			},

			/**
			 * resize handler. 화면 크기가 변할 때 폼 사이즈도 함께 변경 
			 */
			_screenResizeHandler: function(event) {
				this.getMyForm().style.width = this.parentNode.offsetWidth + 'px';
			},

			/**
			 * Resource Form이 오픈 된 후 처리 
			 */
			_resourceFormOpenHandler: function(event) {
				if(event.srcElement.id == 'resource-dialog') {
					this.$['resource-dialog'].refit();
					this.fire('things-std-resource-form-opened', this.$['resource-form'], this.$['resource-dialog']);
				}
			},

			/**
			 * Resource가 변경될 때 
			 * @param {Object} 리소스 
			 */
			_resourceChanged: function(resource) {
				this._bindData(this.$['left-fields'].childNodes, resource);
				this._bindData(this.$['right-fields'].childNodes, resource);
			},

			/**
			 * resource로 elements에 각각 바인딩한다.
			 * @param {Array} elements
			 * @param {Object} resource
			 */
			_bindData: function(elements, resource) {
				for(var i = 0 ; i < elements.length ; i++) {
					elements[i].value = resource[elements[i].name];
				}
			},

			/**
			 * 서버에 저장 요청할 파라미터 중에서 Save 전에 저장에 불필요한 컬럼들을 필터링한다.
			 * @param params 서버에 저장 요청할 파라미터 
			 */
			_filterResourceColumns: function(params) {
				for(var name in params) {
					if(this.removeFieldsOnSave.includes(name)) {
						delete params[name];
					} else {
						var value = params[name];
						if(typeof(value) === 'undefined') {
							delete params[name];
						}
					}
				}

				return params;
			},

			/**
			 * Save 액션 성공 후 후처리 things-std-resource-form-saved 이벤트가 fire된다.
			 */
			_successResponseHandler: function(event) {
				this.stopSpinner();

				var method = event.srcElement.method.toUpperCase();
				if(method == 'GET') {
					this.fire('things-std-resource-form-read', event.detail);
				} else if(method == 'PUT') {
					this.fire('things-std-resource-form-saved', event.detail);
				} else if(method == 'POST') {
					this.fire('things-std-resource-form-created', event.detail);
				}
			},

			/**
			* Error response handler After form submits.
			* StdFormBehavior fires a 'things-std-resource-form-error' in this function
			*/
			_errorResponseHandler: function(event) {
				this.stopSpinner();

				var response = (event.detail && !event.detail.request) ? event.detail : event.detail.request.xhr.response;
				if(response && response.status == 401) {
					this.handleUnauthorized();

				} else {
					if(response) {
						this.openResponseError(response);
					} else {
						response = event.detail.request;
						this.openUnkownError(response);
					}
				}

				this.fire('things-std-resource-form-error', response);
			}			

		});
	</script>

</dom-module>