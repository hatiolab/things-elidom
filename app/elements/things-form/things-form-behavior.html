<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-form/iron-form.html">
<link rel="import" href="../../../bower_components/iron-form-element-behavior/iron-form-element-behavior.html">

<link rel="import" href="../../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../../../bower_components/paper-radio-button/paper-radio-button.html">

<link rel="import" href="../things-setting/things-global-behavior.html">
<link rel="import" href="../things-spinner/things-spinner-behavior.html">
<link rel="import" href="../things-msg-box/things-msgbox-behavior.html">
<link rel="import" href="../things-combo/things-code-selector.html">
<link rel="import" href="../things-date-picker/things-date-picker.html">
<link rel="import" href="../things-date-picker/things-time-picker.html">

<script>

window.Things = window.Things || {};

/**
 * var Things.FormBehavior enables a custom element to be included in an things-search-form or things-resource-form
 *
 * @demo demo/index.html
 * @FormBehavior
 */
Things.FormBehaviorImpl = {

	properties: {
    /**
     * Fired when the form is submitted
     *
     * @event submit
     */
    /**
     * Fired when the successful response is arrived after submit
     *
     * @event response
     */
    /**
     * Fired when the error response is arrived after submit
     *
     * @event error
     */

    /**
     * Form elements of the form.
     * Custom Form element have to configure form elements dynamically.
     * FormBehavior create form element by each of this attributes
     */
		formFields: {
			type: Array,
			observer: '_formFieldsChange'
		},

		/**
		 * Action url of the form. 
		 * This attribute is configured by base url of the global setting.
		 */
		action: {
			type: String
		},
		
		actionUrl: {
			computed: '_computeActionUrl(globals.basicUrl,action)'
		},

		/**
		 * HTTP Method of the form submit.
		 */
		method: {
			type: String
		},

		/**
		 * HTTP Content Type of the form submit.
		 */
		contentType: {
			type: String
		},
		
		/**
		 * Response Data after form submit
		 */
		output: {
			type: Object,
			notify: true
		}
	},

	listeners : {
		'iron-form-response' :'_onSuccessResponse',
		'iron-form-error' : '_onErrorResponse'
	},

  /**
   * Handler after Form element changed.
   * Child elements of the form is reconfigured by this function.
   *
   * @param {Array} formFields attribute
   */
	_formFieldsChange: function(formFields) {
		this.buildFormView();
	},

	/**
	 * compute action url for action
	 */
	_computeActionUrl: function(basicUrl, action) {
		return basicUrl + '/' + action;
	},
	
  /**
   * Create child element of the form by one of the formFields object
   *
   * @param {Object} one of the formFields attribute
   * @return {Object} created child element for the form
   */	 
	_generateElement: function(element) {
		var newElement = null;

		switch(element.type) {
			case 'checkbox':
				newElement = document.createElement('paper-checkbox');
				newElement = this._setAttr(newElement, element);
				newElement.$.checkboxLabel.innerHTML = element.label;
				break;

			case 'button':
				newElement = document.createElement('paper-button');
				newElement = this._setAttr(newElement, element);
				newElement.innerHTML =element.label;
				break;

			case 'listbox':
				newElement = this._makeListBox(element.options);
				newElement = this._setAttr(newElement, element);
				break;

			case 'dropdown':
				newElement = document.createElement('paper-dropdown-menu');
				newElement = this._setAttr(newElement, element);
				newChild = this._makeListBox(element.options);
				newChild.setAttribute('class','dropdown-content');
				newElement.appendChild(newChild);
				break;

			case 'radio':
				newElement = document.createElement('paper-radio-group');
				newElement = this._setAttr(newElement, element);
				for(index in element.child) {
					child = element[index];
					newChild = document.createElement('paper-radio-button');
					newChild = this._setAttr(newChild, child);
					newElement.appendChild(newChild);
				}
				break;

			case 'textarea':
				newElement = document.createElement('paper-textarea');
				newElement = this._setAttr(newElement, element)
				break;

			case 'code-combo':
				newElement = document.createElement('things-code-selector');
				newElement.setAttribute('name', element.name);
				newElement.setAttribute('label', element.label);
				newElement.setAttribute('code-name', element.codeName);
				newElement.setAttribute('label-path', 'description');
				newElement.setAttribute('value-path', 'name');
				break;

			case 'date':
				newElement = document.createElement('things-date-picker');
				newElement.setAttribute('name', element.name);
				newElement.setAttribute('label', element.label);
				break;

			case 'time':
				newElement = document.createElement('things-time-picker');
				newElement.setAttribute('name', element.name);
				newElement.setAttribute('label', element.label);
				break;

			case 'datetime':
				// TODO
				break;

			default:
				newElement = document.createElement('paper-input');
				newElement = this._setAttr(newElement, element);
		}

		newElement.setAttribute('class','flex style-scope things-form');
		return newElement;
	},

	/**
	 * list box creation
	 *
	 * @param{Array} items Listbox values
	 * @return {Object} paper-listbox element 
	 */
	_makeListBox: function(items) {
		var listbox = document.createElement('paper-listbox');
		listbox.setAttribute('selected','0');
		
		for(index in items) {
			option = items[index];
			item = document.createElement('paper-item');
			item.innerHTML = option;
			listbox.appendChild(item);
		}

		return listbox;
	},

	/**
	 * Set element's attributes by one of formFields 
	 */
	_setAttr: function(element, attrs) {
		for(attr in attrs) {
			element.setAttribute(attr, attrs[attr]);
		}

		return element;
	},

	/**
	 * find form by querySelector and return found form
	 * @return {Object}
	 */
	_getForm: function() {
		return this.querySelector('form');
	},

	/**
	 * Resets form
	 */
	_resetForm: function() {
		this._getForm().reset();
	},

	/**
	 * Submits form
	 * After form submits, FormBehavior fires a 'submit'
	 */
	_submitForm: function() {
		this.startSpinner();

		if(this.getAttribute('on-submit')) {
			this.fire('submit', this._serializeForm());
		} else {
			this._getForm().submit();
		}
	},

	/**
	 * Serialize form and return serialized object.
	 * It can be used form parameters
	 * @return {Object} serialized object
	 */
	_serializeForm: function() {
		return this._getForm().serialize();
	},

	/**
	 * key event - form submits when enter key is monitored
	 * @param {Event} event A 'KeyPressed' event
	 */
	_keyPressHandler: function(event) {
		var code = event.keyCode;
		if(code == 13) {
			this._submitForm(event);
		}
	},	

	/**
	 * Successful response handler After form submits.
	 * FormBehavior fires a 'response' in this function
	 * @param {Event} event Successful response event
	 */
	_onSuccessResponse: function(event) {
		this.stopSpinner();

		if(this.rootProperty) { 
			this.output = event.detail.xhr.response[this.rootProperty]; 
		} {
			this.output = event.detail.xhr.response;
		}
		
		this.fire('response', this.output);
	},

	/**
	 * Error response handler After form submits.
	 * FormBehavior fires a 'error' in this function
	 * @param {Event} event Error response event
	 */
	_onErrorResponse: function(event) {
		this.stopSpinner();
		var response = event.detail.request.xhr.response;

		if(response && response.status == 401) {
			this.handleUnauthorized();
			this.fire('error', response);
		} else {
			if(response) {
				this.openResponseError(response);
				this.fire('error', response);
			} else {
				this.openUnkownError();
				this.fire('error', event.detail.request);
			}
		}
	}
};

Things.FormBehavior = [
	'IronFormElementBehavior', 
	Things.FormBehaviorImpl, 
	Things.SpinnerBehavior, 
	Things.MsgBoxBehavior,
	Things.GlobalBehavior
];

</script>