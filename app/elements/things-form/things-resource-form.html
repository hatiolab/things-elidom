<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/iron-icons/social-icons.html">
<link rel="import" href="../../../bower_components/iron-icons/maps-icons.html">
<link rel="import" href="../../../bower_components/iron-iconset/iron-iconset.html">
<link rel="import" href="../../../bower_components/iron-iconset-svg/iron-iconset-svg.html">
<link rel="import" href="../../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../../../bower_components/paper-fullscreen-dialog/paper-fullscreen-dialog.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">

<link rel="import" href="./things-form-behavior.html">

<!--
A comment describing this element

Example:

	<my-elem></my-elem>

Example:

	<my-elem>
	  <h2>Hello my-elem</h2>
	</my-elem>

@demo demo/index.html
-->

<dom-module id="things-resource-form">
	<template>
		<style is="custom-style" include="iron-flex iron-flex-alignment">
		<style>
			:host {
				display: block;
				box-sizing: border-box;
				/*text-align: center;*/
				/*margin: 100px auto;*/
				height: 90%;
				width: 90%;
			}

			:host .resourceForm {
				padding: 10px 15px 10px 15px;
			}

			:host .fields {
				padding: 10px;
			}
		</style>

		<paper-fullscreen-dialog
			id="resourceDialog"
			modal="true"
			dismiss-icon="close">

			<h2>{{title}}</h2>
			
			<paper-button affirmative dialog-confirm on-tap="saveResourceForm">Save</paper-button>
			
			<form
					is="iron-form" 
					id="resourceForm" 
					class="resourceForm"
					action=[[action]]
					headers="[[headers]]"
					content-type="[[contentType]]"
					method="[[method]]"
					last-response ="{{output}}">
				<div class="layout horizontal flex" >
					<div id="leftFields" class="layout vertical flex fields"></div>
					<div id="rightFields" class="layout vertical flex fields"></div>
				</div>
			</form>
		</paper-fullscreen-dialog>
	</template>

	<script>
		Polymer({
			is: 'things-resource-form',
			
			properties: {
				title: String
			},

			/**
			 * view atrribute observer, add view to form
			 */
			buildFormView: function() {
				for(index in this.formFields) {
					var field = this.formFields[index];
					var newElement = this._generateElement(field);

					if((index % 2) == 0) {
						this.$.leftFields.appendChild(newElement);
					} else {
						this.$.rightFields.appendChild(newElement);
					}
				}
			},

			behaviors: [
				ThingsFormBehavior,
				Polymer.IronResizableBehavior
			],

			listeners : {
				'resourceDialog.iron-overlay-closed': 'clearResourceForm',
				'resourceDialog.iron-overlay-canceled': 'clearResourceForm',
				'resourceDialog.iron-overlay-opened': 'onOpenResourceForm',
				'iron-resize': 'onIronResize'
			},

			/**
			 * resize handler 
			 */
			onIronResize: function() {
				this.$.resourceForm.style.width = this.parentNode.offsetWidth + 'px';
			},

			/**
			 * save data from resource detail screen
			 */
			saveResourceForm: function() {
				this.method ='put';
				this._submitForm();
			},

			/**
			 * after resource opened
			 */
			onOpenResourceForm: function(e) {
				if(e.srcElement.id == 'resourceDialog') {
					this.$.resourceDialog.refit();
					this.fire('resource-form-opened', this.$.resourceForm, this.$.resourceDialog);
				}
			},

			/**
			 * open resource form dialog
			 */
			openResourceForm: function(e) {
				var data = e.detail;

				if(this.$.leftFields.childNodes.length == 0) {
					this.buildFormView();
				}

				// TODO set value to element
				this.$.resourceDialog.toggle();
			},

			/**
			 * clear resource form
			 */
			clearResourceForm: function(e) {
				if(e.srcElement.id == 'resourceDialog') {
					var i = 0;

					while(this.$.leftFields.childNodes.length > 0 ||this.$.rightFields.childNodes.length > 0) {
						if(this.$.leftFields.childNodes[0])
							this.$.leftFields.removeChild(this.$.leftFields.childNodes[0]);

						if(this.$.rightFields.childNodes[0])
							this.$.rightFields.removeChild(this.$.rightFields.childNodes[0]);
					}
				}
			}

		});
	</script>

</dom-module>