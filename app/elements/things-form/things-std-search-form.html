<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/iron-input/iron-input.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../../bower_components/iron-form/iron-form.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../../../bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="../../../bower_components/paper-input/paper-textarea.html">

<link rel="import" href="./things-std-form-behavior.html">

<!--
`<things-std-search-form>` is an HTML `<form>` element that can search data by configure form fields dinamically.

  Example

    <things-resource 
      auto
      action="diy_services/ElidomSearchForm/query.json" 
      output-data="{{formFields}}">
    </things-resource>

    <things-std-search-form 
      id="search-form"
      class="flex"
      title="Sample Title"
      form-fields="[[formFields]]" 
      action-url="diy_services/DynamicScreen/query.json" 
      use-pagination=true
      page="{{page}}"
      per-page="{{limit}}"
      total-count="{{totalCount}}"
      total-property="total"
      root-property="items"
      items="{{items}}">
    </things-std-search-form>

@demo ./things-form/demo/demo-things-std-search-form.html
-->

<dom-module id="things-std-search-form">
  <template>
    <style is="custom-style" include="iron-flex iron-flex-alignment">
    <style>
    :host {
      display: block;
      box-sizing: border-box;
      /*text-align: center;*/
      /*margin: 0 auto;*/
      height: 100%;
      width: 98%;
    }
        
    :host paper-input {
      margin-left: auto;
      margin-right: auto;
      width: 90%;
    }

    :host things-code-selector {
      margin-left: auto;
      margin-right: auto;
      width: 90%;
    }    
    
    :host paper-material {
      padding: 15px;
    }

    :host .search {
      padding:5px 0 3px 5px;
    }

    :host .fields {
      padding: 0px 10px 0px 0px;
    }
    
    </style>

    <paper-material elevation="1" class="flex" on-keypress="_keyPressHandler">
      <paper-toolbar>
        <paper-icon-button icon="menu"></paper-icon-button>
        <span class="title">[[title]]</span>
        <paper-icon-button icon="search" id="search-btn" on-click="submitMyForm"></paper-icon-button>
        <paper-icon-button icon="refresh" id="reset-btn" on-click="resetMyForm"></paper-icon-button>
        <paper-tooltip for="search-btn" offset="0">Search</paper-tooltip>
        <paper-tooltip for="reset-btn" offset="0">Reset</paper-tooltip>
      </paper-toolbar>

      <div class="layout vertical flex">
        <form is="iron-form"
              action="[[action]]"
              content-type="[[contentType]]"
              last-response ="{{lastResponse}}">

          <div class="layout horizontal flex" >
            <div id="leftFields" class="layout vertical flex fields"></div>
            <div id="rightFields" class="layout vertical flex"></div>
          </div>
        </form>
      </div>
    </paper-material>
  </template>

  <script>

  Polymer({

    is: 'things-std-search-form',

    properties: {
      /**
       * Toolbar에 표시할 화면 타이틀 
       */
      title: {
        type: String
      },

      /**
       * Pagination을 적용 할 것인지 여부
       */
      usePagination: {
        type: Boolean,
        value: true
      },

      /**
       * Pagination을 위한 설정. 페이지에 표시할 데이터 개수
       */
      perPage: {
        type: Number,
        value: 50,
        notify: true
      },

      /**
       * Pagination을 위한 설정. 현재 페이지 수 
       */
      page : {
        type: Number,
        value: 1,
        notify: true,
        observer: '_pageChanged'
      },

      /**
       * 검색 결과 중에서 리스트 데이터를 의미하는 프로퍼티 
       */
      rootProperty: {
        type: String,
        value: 'items'
      },

      /**
      * 검색 결과 중에서 검색 조건에 해당하는 총 데이터 카운트를 의미하는 프로퍼티 
      */
      totalProperty: {
        type: String,
        value: 'total'
      },

      /**
       * 검색 결과 최종 리스트 데이터 
       * lastResponse가 Object {total : 100, items : [...]} 형태일 경우 items에 해당한다.
       */
      items: {
        type: Array,
        notify: true
      },

      /**
       * 검색 조건에 맞는 총 데이터 개수 
       */
      totalCount: {
        type: Number,
        notify: true
      }      

    },
    
    behaviors: [ Things.StdFormBehavior ],

    listeners : {
      'iron-form-presubmit' :'_preSubmitHandler'
    },    

    /**
     * 검색 폼 화면을 구성. formFields로 
     */
    reconfigureMyForm: function() {
      if(this.formFields.length > 0) {
        for(index in this.formFields) {
          var field = this.formFields[index];
          var newElement = this.createFormElement(field);

          if((index % 2) == 0) {
            this.$.leftFields.appendChild(newElement);
          } else {
            this.$.rightFields.appendChild(newElement);
          }
        }
      }
    },

    /**
     * Submit 전에 전처리
     * @param {Event}
     */
    _preSubmitHandler: function(event) {
      var form = this.getMyForm();
      form.request.params || {};
      form.request.params.page = this.page;
      form.request.params.limit = this.perPage;
    },

    /**
     * 현재 페이지가 변경되었을 때 액션
     * 페이지가 변경된 경우 해당 페이지로 다시 검색한다.
     * @param {Number} page 현재 페이지 
     */
    _pageChanged: function(page) {
      if(this.totalCount > 0 && page > 0) {
        this.submitMyForm();
      }
    },

    /**
    * Successful response handler After form submits.
    * StdFormBehavior fires a 'things-std-form-response' in this function
    * @param {Event} event Successful response event
    */
    _onSuccessResponse: function(event) {
      this.stopSpinner();

      if(this.usePagination) { 
        this.items = event.detail.xhr.response[this.rootProperty];
        this.totalCount = event.detail.xhr.response[this.totalProperty];
      } {
        this.items = event.detail.xhr.response;
      }

      this.fire('things-std-form-response', { items : this.items, total : this.totalCount } );
    },

    /**
    * Error response handler After form submits.
    * StdFormBehavior fires a 'things-std-form-error' in this function
    * @param {Event} event Error response event
    */
    _onErrorResponse: function(event) {
      this.stopSpinner();

      var response = event.detail.request.xhr.response;
      if(response && response.status == 401) {
        this.handleUnauthorized();

      } else {
        if(response) {
          this.openResponseError(response);
        } else {
          response = event.detail.request;
          this.openUnkownError(response);
        }
      }

      this.fire('things-std-form-error', response);
    }    

  });
  </script>
</dom-module>
