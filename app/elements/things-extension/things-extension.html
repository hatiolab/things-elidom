<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/iron-icons/social-icons.html">
<link rel="import" href="../../../bower_components/iron-icons/maps-icons.html">
<link rel="import" href="../../../bower_components/iron-iconset/iron-iconset.html">
<link rel="import" href="../../../bower_components/iron-iconset-svg/iron-iconset-svg.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">

<link rel="import" href="../things-button/things-button.html">
<link rel="import" href="../things-combo/things-resource-selector-behavior.html">
<link rel="import" href="../things-grid/things-resource-grid.html">
<link rel="import" href="../things-file-upload/things-file-upload.html">
<link rel="import" href="../things-resource/things-resource.html">

<link rel="import" href="../things-content/things-load-view-behavior.html">
<link rel="import" href="../things-content/things-resource-meta-behavior.html">
<link rel="import" href="../things-content/things-route-content-behavior.html">
<link rel="import" href="../things-msg-box/things-msgbox-behavior.html">
<link rel="import" href="../things-setting/things-global-behavior.html">

<dom-module id="things-extension">
  <template>
    <div class="[[layout]]">
      <things-resource 
        id="resourceSearch"
        method="GET"
        action="[[gridSearchUrl]]"
        last-response="{{lastResponse}}"
        auto>
      </things-resource>

      <things-resource-grid 
        id="grid"
        config="[[gridConfig]]"
        model="[[gridModel]]" 
        columns="[[gridColumns]]"
        data="[[lastResponse]]"
        grid-save-action="[[gridSaveUrl]]"
        buttons="[[buttons]]"
        enable-detail-column
        enable-toolbar>
      </things-resource-grid>
      
    </div>

  </template>

  <script>
    Polymer({
      is: 'things-extension',

      behaviors: [ 
        Things.MsgBoxBehavior
      ],
      
      properties: {
        type: {
          type: String
        },

        id: {
          type: String
        },

        gridModel: {
          type: Object,
          value: function() {
            return [
              { 'fieldName' : 'name' },
              { 'fieldName' : 'value' }
            ]
          }
        },
        
        gridColumns: {
          type: Object,
          value: function() {
            return [
              { 'fieldName' : 'name' },
              { 'fieldName' : 'value' },
            ]
          }
        },
        /**
         * 그리드 검색 URL
         */
        gridSearchUrl: {
          type: String,
          computed: '_computeGridSearchUrl(type, id)',
        },

        /**
         * 그리드 save URL
         */
        gridSaveUrl: {
          type: String,
          computed: '_computeGridSaveUrl()'
        },

        /**
         * 버튼 정보 
         */
        buttons: {
          type: Array,
          value: [ {
            id: 'add',
            text: 'Add',
            icon: 'icons:add'
          },{
            id: 'save',
            text: 'Save',
            icon: 'icons:save'
          }]
        }
      },

      listeners : {
        'grid.things-grid-detail-tap': '_showResourceForm',
        'grid.things-grid-resource-column-edit' : '_openResourceSelector'
      },

       /**
        * Grid Search URL 생성
        */
       
       _computeGridSearchUrl: function(type, id) {
        return ['properties', type, id].join('/');
       },

      /**
       * resourceUrl로 grid save url을 생성
       * @param {String} resourceUrl
       * @return {String} grid save URL
       */
      _computeGridSaveUrl: function() {
        return 'http://192.168.35.225:9002/rest/properties/' + '/update_multiple.json';
      },

      _onGridUrlChange:function(url){
        this.$.resourceSearch.action=url;
        this.$.resourceSearch.generateRequest();
      }


      // /**
      //  * 그리드 셀 선택이 변경되었을 경우 핸들러 
      //  */
      // _onDetailButtonTap: function(e) {
      //   var basicUrl = this.get('globals.basicUrl');
      //   this.openConfirmMsg({
      //     title : 'Do you want to download file?',
      //     type : 'info',
      //     text : 'You can download file'
      //   }, function() {
      //     window.location = basicUrl + '/download/' + e.detail.id;
      //   });
      // },

      // /**
      //  * 메뉴에 등록된 자신의 routing 정보를 리턴한다.
      //  */
      // getMyRoute: function() {
      //   return this.resourceUrl;
      // },

      // /**
      //  * 화면 초기화 함수 
      //  * 메타 데이터를 서버로 요청하여 화면을 구성한다.
      //  */
      // initializeContent: function() {
      //   this.$['resource-meta'].generateRequest();
      // },

      // /**
      //  * Open Resource Selector Dialog
      //  *
      //  * @param {Object} event
      //  */
      // _openResourceSelector: function(event) {
      //   var index = event.detail.index;
      //   this.openResourceSelectorByGrid(index._grid, index.rowIndex, event.detail.userObj, true);


      //   var index = event.detail.index;
      //   var grid = index._grid;
      //   var column = index.column;
      //   var rowIdx = index.rowIndex;
      //   var resourceObj = event.detail.userObj;

      //   var selector = document.createElement('things-resource-content');
      //   selector.id = 'resource-dialog';
      //   selector.layout = 'fullbleed layout vertical';
      //   selector.title='StorageInfo';
      //   selector.resourceRoute='StorageInfo';
      //   selector.resourceName='StorageInfo';
      //   selector.resourceUrl='storage_infos';
      //   selector.enableToolbar = false;
      //   selector.initializeContent();
      //   this.openPopupView(selector, true, selector.refreshGridData);
      //   var me = this;

      //   selector.addEventListener('things-grid-row-data-select', function(e) {
      //     var valueField = resourceObj.valueField;
      //     var row = grid.focusedRow();
      //     var dataSet = grid.dataSource();

      //     if(row && row.dataIndex() >= 0) {
      //       var rowObj = row.getRowObject();
      //       var selectedObj = rowObj[resourceObj.valueField];
      //       selectedObj.id = e.detail.id;
      //       selectedObj[resourceObj.delegateColumn] = e.detail[resourceObj.delegateColumn];
      //       rowObj[resourceObj.valueField] = selectedObj;
      //       rowObj[column._name] = e.detail.id;
      //       dataSet.updateRow(rowIdx, rowObj);
      //       // popup 닫기 
      //       me.closePopupView();
      //       // 부모 그리드 Refresh         
      //       grid.refreshView();
      //     }
      //   });
      // }

    });
  </script>
</dom-module>