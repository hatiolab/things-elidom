<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../things-global-behavior/things-global-behavior.html">

<!--
`<things-i18n-msg>` is a client-side solution for i18n message string replacement. It is modeled off the [Chrome extension i18n API](https://developer.chrome.com/extensions/i18n), which uses a `messages.json` file format.
The file contains localized strings for the language in question.

To set the language across your site, define `this.globals.locale` in your main page:

    document.addEventListener('HTMLImportsLoaded', function() {
      dataGlobal.locale = 'en-US';
      dataGlobal.locale = 'en-US';
    });

<b>Note:</b> this is done in `HTMLImportsLoaded` so `I18nMsg` will be defined by
the time you set `this.globals.locale`. This timing is necessary under the polyfill and is
<b>not needed if the browser supports HTML Imports</b>, natively.

<b>Note:</b> you must call `Platform.performMicrotaskCheckpoint()` whenever
making a change to the `I18nMsg` object. This is required due to the removal
of `Object.observe()`.

### Message files

Setting a language instructs `<things-i18n-msg>` to read message ids from a predefined
file on your server. For example, `this.globals.locale = 'es'` will use `locales/es.json`.
`this.globals.locale = 'fr'` would use message strings from `locales/fr.json`.

The directory name can be configured by using the `messagesUrl` property, but the file
cannot. `<things-i18n-msg>` will always attempt to use messages from `<messagesUrl>/<LANG_YOU_SET>.json`.
You can also set and/or change this location globally, at any time, by setting `this.globals.url`.

<b>Example</b> - using a custom locales folder, setting it globally for all `<things-i18n-msg>` instances:

    this.globals.url = 'locales';

<b>Example</b> - set locales folder path on individual element:

    <i18n-msg messages-url="path/to/locales">fallback text</i18n-msg>

<b>Note:</b> message files are read once and reused for all instances of `<things-i18n-msg>`.

### Fallback text

If an appropriate message file can't be found, the `textContent` of the element is used as fallback text.

    <i18n-msg msgid="unknownmsgid">fallback text</i18n-msg>

### Full example

    <html lang="es">
      ...
      <body>
        <p>"Days" in Spanish is <i18n-msg msgid="days">days</i18n-msg>!</p>
        <script>
          this.globals.locale = document.documentElement.lang || 'en';
        </script>
      </body>
    </html>

### Getting a message:

    // No argument returns the instance's message:
    document.querySelector('i18n-msg').getMsg();

    // Get a message by an id:
    document.querySelector('i18n-msg').getMsg('days');

@demo demo/index.html
-->
<dom-module id="things-i18n-msg">
<script>
(function () {

  var _thingsI18nInstances = []; // Holds all i18n-msg elements to have them easily updated with translation messages.
  var _thingsI18nfetching = false; // True if there's an outstanding XHR fetching a locale file.
  var _thingsI18nInstancesUpdated = 0;

  Polymer({
    is: 'things-i18n-msg',

    /**
     * The `i18n-language-ready` is fired after the locale was fetched and all `<things-i18n-msg>` elements were updated.
     *
     * @event i18n-language-ready
     * @detail {{language: String}}
     */
    
    /**
     * The `i18n-load-language-failure` is fired when xhr status is not 200 or 0
     *
     * @event  i18n-load-language-failure
     * @detail e.target
     */
    
    /**
     * The `i18n-load-language-error` is fired when xhr.onerror event fired
     * @event  i18n-load-language-error
     * @detail e.target
     */

    properties: {
      /**
       * The message id (key) for this message.
       */
      msgid: {
        type: String,
        value: null,
        observer: '_msgidChanged'
      },

      /**
       * The language being used.
       */
      language: {
        type: String,
        value: null,
        observer: '_languageChanged',
        readOnly: true
      },

      /**
       * The folder name where the localized files are located.
       * it mix with `this.globals.url` if not `null` + messagesUrl to find server resource.
       */
      messagesUrl: {
        type: String,
        value: 'terminologies/resource'
      },

      msg :{
        type:String,
        notify:true
      }
      
    },

    /**
     * An object containing the set of known language locales that have been loaded.
     */
    locales: {
      type: Object,
      value: _thingsDataGlobal.locales // static
    },
    behaviors: [
      Things.GlobalBehavior
      // Things.MsgBoxBehavior
    ],
    observers:[
      '_observerUrl(globals.baseUrl)',
      '_observerLang(globals.locale)',
      '_observerMessageUrl(messagesUrl)'
    ],
    /**
     * Observer Lib를 사용하여 전역 변수  things.globals.baseUrl과 this.globals.locale을 monitoring하고 있음 
     * 변경시 Json을 다시 받아와서 번역결과를 반영함.
     */
    ready: function() {
      _thingsI18nInstances.push(this);
    },
    /**
     * Observe Globals locale
     */
    _observerLang:function (locale) {
      _thingsI18nInstancesUpdated = 0;
      if(locale) this._setLanguage(locale);
    },
    /**
     * Observe Globals base url
     */
    _observerUrl:function (url) {
      _thingsI18nInstancesUpdated = 0;
      if(url) this._fetchLanguage();
    },

    _observerMessageUrl:function(messagesUrl){
      _thingsI18nInstancesUpdated = 0;
      if(messagesUrl) this._fetchLanguage();
    },

    attached: function() {
      var msg = this.getMsg(this.msgid)
      if (msg) {
        this.innerHTML = msg;
        this.msg = msg;
      }
    },
    /**
     * 
     * @param {string=} opt_msgId Optional message id to lookup. If left off,
     * the instance's `msgid` property is used.
     * 
     * @param {Object=} dataset 검색하는 Message중에서 대체해야하는 변수를 key:Value 형태로 
     * 전송하여 msg내 해당 되는 Key와 같은 변수가 있으면 replace 없으면 아무작업하지 않음.
     * 
     * @return {string|null} a message in the current locale (set by `this.globals.locale`). Translated message or `null` if not found, 
     */
    getMsg: function(opt_msgId,dataset) {
      var msgId = opt_msgId || this.msgid;
      var lang = this.locales[this.language];
      if (lang && lang[msgId]) {
        if(dataset){
          return this._replaceMsgVariable(lang[msgId], dataset);
        }
        return lang[msgId];
      }
      return null;
    },

    /**
     * msgid가 바뀌면 Message정보를 변경한다.
     */
    _msgidChanged: function() {
      if (this.language && this.locales[this.language] && !_thingsI18nfetching && this.msgid) {
        this._updateElementMessage();
      }
    },
    /**
     * language가 바뀌면 현재 Dom의 locales중에 해당 언어가 있으면 해당 언어의 message값으로 바꾸고
     * 없으면 XHR을 통하여 Json정보를 가져온다.
     */
    _languageChanged: function() {
      // Don't fetch .json file if it has already been
      // fetched or another instance is already trying to.
      if (this.language && this.locales[this.language] && !_thingsI18nfetching) {
        // Send one signal that language changed to outside.
        if (_thingsI18nInstancesUpdated == _thingsI18nInstances.length - 1) {
          this.fire('i18n-language-ready', {language: this.language});
        }

        this._updateElementMessage();
        _thingsI18nInstancesUpdated++;

        return;
      } else if (!this.language || this.locales[this.language] || _thingsI18nfetching) {
        return;
      }

      this._fetchLanguage();
    },
    /**
     * this.globals.url기본으로 데이타를 받아오지만 만일 messagesUrl에 값이 있으면 messagesUrl을 기준으로 한다.
     * terminologies/resource.json을 합쳐서 해당 Json파일을 받아온다.
     */
    _fetchLanguage: function() {
      if (_thingsI18nfetching) {
        return;
      }

      _thingsI18nfetching = true;

      if(!this.globals.baseUrl||!this.messagesUrl||!this.language){
        if(!this.globals.baseUrl){
          // Do not thing
        }else if(!this.messagesUrl){
          console.warn('message url is null')
        }else{
          console.warn('language is null')
        }
        _thingsI18nfetching= false;
        return;
      }

      if(this.locales[this.language]&&this.locales[this.language].length>0){
        return;
      }

      var url = this.globals.baseUrl+'/'+this.messagesUrl+'/'+this.language+'.json';

      //1. create xhr requesst
      var xhr = new XMLHttpRequest();
      xhr.open('GET', url);
      xhr.setRequestHeader("Content-type", "application/json");
      xhr.withCredentials = true;

      //add response event
      xhr.onload = function(e) {
       
        if (e.target.status !== 200 && e.target.status !== 0) {
          console.log('i18n-load-language-failure');
          this.fire('i18n-load-language-failure', e.target);
          return;
        }

        var resp = JSON.parse(e.target.response)[this.language];


        if (!this.msgid in resp) {
          console.warn(this.localName + ': "' + this.msgid + '" message id was not found in ' + url);
          return;
        }

        this.locales[this.language] = resp; // cache this locale.

        this._notifyInstances();

        this.fire('i18n-language-ready', {language: this.language});
        _thingsI18nfetching = false;
      }.bind(this);

      // add error event
      xhr.onerror = function(e) {
        _thingsI18nfetching = false;
        console.log('i18n-load-language-error');
        this.fire('i18n-load-language-error', e.target);
      };
      //3. make domain object and send request
      var requestValue= {};

      requestValue = {"domain" :this.getDomainId(), "locale" : this.globals.locale};
      xhr.send(JSON.stringify(requestValue));
    },
    /**
     * get domain id from user information
     */
    getDomainId : function(){
      if(this.globals.user){
        return this.globals.user.domain_id
      }else{
        return 1
      }
    },
    /**
     * 현재 Tag가 존재하는 위치내에 메시지를 opt_instance.innerHtml에 반영한다.
     */
    _updateElementMessage: function(opt_instance) {
      var instance = opt_instance || this;

      var msg = this._replaceMsgVariable(instance.locales[instance.language][instance.msgid], instance.dataset);
      if (msg) {
        instance.innerHTML = msg;
        instance.msg = msg;
      }
    },
    /**
     * 모든 저장해 놓은 instance에 변경된 메시지를 updadte한다.
     */
    _notifyInstances: function() {
      for (var i = 0, instance; instance = _thingsI18nInstances[i]; ++i) {
        instance._setLanguage(this.globals.locale);

        if (!instance.locales[instance.language][instance.msgid]) {
          console.warn(this.localName + ': "' + instance.msgid + '" message id was not found');
          continue;
        }

        this._updateElementMessage(instance);
      }
    },
    /**
     * 메시지 내에 포함되어 있는 변수를 교채한다.
     * @param {string=} message 내용
     * @param {Object=} dataset 검색하는 Message중에서 대체해야하는 변수를 key:Value 형태로 
     * 전송하여 msg내 해당 되는 Key와 같은 변수가 있으면 replace 없으면 아무작업하지 않음.
     */
    _replaceMsgVariable: function (message, dataset) {
      Object.keys(dataset).forEach(function(data){
        var bracedData = '{'+data.replace(/\$/, '\\$')+'}'
        var regEx = new RegExp(bracedData, "gi");
        message = message.replace(regEx, dataset[data]);
      })
      return message;
    }

  });

})();
</script>
</dom-module>