<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/iron-icons/social-icons.html">
<link rel="import" href="../../../bower_components/iron-icons/maps-icons.html">
<link rel="import" href="../../../bower_components/iron-iconset/iron-iconset.html">
<link rel="import" href="../../../bower_components/iron-iconset-svg/iron-iconset-svg.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">

<link rel="import" href="../things-button/things-button.html">
<link rel="import" href="../things-combo/things-resource-selector-behavior.html">
<link rel="import" href="../things-grid/things-resource-grid.html">
<link rel="import" href="../things-file-upload/things-file-upload.html">
<link rel="import" href="../things-resource/things-resource.html">

<link rel="import" href="../things-content/things-load-view-behavior.html">
<link rel="import" href="../things-content/things-resource-meta-behavior.html">
<link rel="import" href="../things-content/things-route-content-behavior.html">
<link rel="import" href="../things-msg-box/things-msgbox-behavior.html">
<link rel="import" href="../things-setting/things-global-behavior.html">

<dom-module id="things-attached-file">
  <template>
    <div class="[[layout]]">
      <things-resource 
        id="resource-search"
        method="GET"
        action=""
        resource="[[gridSearchUrl]]"
        select-fields="[[selectFields]]"
        sort-fields="[[sortFields]]"
        query-fields="[[queryFields]]"
        last-response="{{lastResponse}}">
      </things-resource>

      <things-resource-grid 
        id="grid"
        config="[[gridConfig]]"
        model="[[gridModel]]" 
        columns="[[gridColumns]]"
        data="[[lastResponse.items]]"
        enable-detail-column
        enable-toolbar>
      </things-resource-grid>
      
    </div>

    <div>
      <paper-button raised dialog-confirm on-tap="search">Search</paper-button>
    </div>

  </template>

  <script>    
    Polymer({
      is: 'things-attached-file',

      behaviors: [
        Things.MsgBoxBehavior
      ],

      properties: {
        entityType: {
          type: String
        },

        entityId: {
          type: String
        },

        resouceName: {
          type: String
        },

        /**
         * Grid Model
         * 
         * @type {Array}
         */
        gridModel: {
          type: Array,
          value: [{
            fieldName: 'name'
          }, {
            fieldName: 'storage_info',
            dataType: 'object'
          }, {
            fieldName: 'tag'            
          },  {
            fieldName: 'path'            
          }, {
            fieldName: 'file_size'
          }, {
            fieldName: 'creator',
            dataType: 'object'
          }, {
            fieldName: 'created_at'
          }]
        },

        /**
         * Grid Columns
         * 
         * @type {Array}
         */
        gridColumns: {
          type: Array,
          value: [{
            fieldName: 'name',
            width: 150
          }, {
            name: 'storage_info',
            fieldName: 'storage_info',
            width: 120,
            valueType: 'text',
            type: 'calced',
            header: {
              text : 'Storage'
            },
            valueCallback : function(column, row) {
              var obj = row.getValue('storage_info');
              return obj ? obj.name : '';
            }
          }, {
            fieldName: 'tag',
            width: 100
          }, {
            fieldName: 'path',
            width: 300
          }, {
            fieldName: 'file_size',
            width: 80
          }, {
            name: 'creator',
            fieldName: 'creator',
            width: 100,
            valueType: 'text',
            type: 'calced',
            header: {
              text : 'Creator'
            },
            valueCallback : function(column, row) {
              var obj = row.getValue('creator');
              return obj ? obj.name : '';
            }
          }, {
            fieldName: 'created_at',
            width: 130
          }]
        },

        /**
         * Select field 
         * 쿼리 필드 설정
         * 
         * @type {String}
         */
        selectFields: {
          type: String,
          value: 'id,name,storage_info_id,tag,path,file_size,creator,created_at'
        },

        /**
         * Sort field 
         * 소팅 필드 설정
         * 
         * @type {String}
         */
        sortFields: {
          type: Array,
          value: [ {
            field: 'created_at',
            ascending: false
          } ]
        },

        /**
         * Query field 
         * 쿼리 조건 설정
         * 
         * @type {Object}
         */
        queryFields: {
          type: Array,
          computed: '_computeQueryFields(entityType,entityId)'
        },

        /**
         * Grid Search URL
         *
         * 
         */
        gridSearchUrl: {
          type: String,
          value: 'attachments'
        }
      },

      listeners: {
        'grid.things-grid-detail-tap': '_showResourceForm',
        'grid.things-grid-resource-column-edit': '_openResourceSelector'
      },

      search: function() {
        this.$['resource-search'].generateRequest();
      },

      _computeQueryFields: function(entityType, entityId) {
        if(!this.queryFields || this.queryFields.length == 0) {
          return [{
            name: 'onType',
            operator: 'eq',
            value: this.entityType
          }, {
            name: 'onId',
            operator: 'eq',
            value: this.entityId
          }];
        } else {
          var newQueryFields = this.queryFields;
          newQueryFields[0].value = this.entityType;
          newQueryFields[1].value = this.entityId;
          return newQueryFields;
        }
      }
      
    });
  </script>
</dom-module>