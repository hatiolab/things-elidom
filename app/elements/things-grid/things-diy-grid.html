<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../../../bower_components/paper-toolbar/paper-toolbar.html">

<link rel="import" href="../things-paginator/things-paginator.html">
<link rel="import" href="../things-grid-behavior/things-grid-basic-behavior.html">

<!--
서버에서 관리하는 DiyGrid 정보를 조회해서 그리드를 구성하는 동적 그리드. 

	Example:

	  <things-diy-grid diy-grid-id="1">
	  </things-diy-grid>	

@demo ./things-grid/demo/demo-things-diy-grid.html
-->

<dom-module id="things-diy-grid">
	<template>
		<style>
			:host {
				display: block;
				height: 100%;
				width: 100%;
				padding: 10px 0px 0px 0px;
			}
		</style>
	
		<div id="{{gridContainerId}}"></div>

		<things-ajax 
			auto
			id="resource-meta"
			method="GET"
			resource-url="[[resourceMetaUrl]]"
			last-response="{{metaData}}">
		</things-ajax>

		<paper-toolbar class="white" hidden$="{{!enableToolbar}}">
			<div id="gridToolbar" class="bottom fit" hidden$="{{!paginatable}}">
				<things-paginator
					id ="paginator"
					per-page="{{perPage}}" 
					current-page="{{currentPage}}" 
					total-count="[[totalCount]]"
					page-start-idx="[[pageStartIdx]]"
					page-end-idx="[[pageEndIdx]]">
				</things-paginator>

				<content id="toolbarContent" select=".grid-toolbar-content"></content>
			</div>
		</paper-toolbar>

	</template>

	<script>
		Polymer({
			is: 'things-diy-grid',

			behaviors: [
				Things.GridBasicBehavior
			],
	
			properties: {
				/**
				 * diyGrid Id
				 */
				diyGridId: {
					type: String
				},

				/**
				 * Grid meta data search url
				 */
				resourceMetaUrl: {
					type: String,
					computed: '_computeDiyGridMetaUrl(diyGridId)'
				},

				/**
				 * Grid meta data
				 */
				metaData: {
					type: Object,
					observer: '_metaDataChanged'
				},

				/**
				 * use page nate or not
				 */
				paginatable: {
					type: Boolean,
					value: false
				},

				/**
				 * page limit
				 * @type {Object}
				 */
				perPage: {
					type: Number,
					notify: true
				},

				/**
				 * current page
				 */
				currentPage: {
					type: Number,
					notify: true
				},

				/**
				 * total data count
				 */
				totalCount: {
					type: Number,
					notify: true
				},

				/**
				 * if enable toolbar or not
				 */
				enableToolbar: {
					type: Boolean,
					value: false
				},

				/**
				 * 그리드 footer를 보여줄 지 여부 
				 */
				showGridFooter: {
					type: Boolean,
					value: false
				}

				/**
				 * 그리드가 구성되고 난 후 fire
				 *
				 * @event things-grid-configured
				 */
				/**
				 * 그리드 Row Data가 선택되었을 경우 fire
				 *
				 * @event things-grid-row-data-select
				 */
				/**
				 * 그리드 Cell Data가 선택되었을 경우 fire
				 *
				 * @event things-grid-cell-data-select
				 */
				/**
				 * 그리드 Cell 중에 Detail 아이콘이 선택되었을 경우 fire
				 *
				 * @event things-grid-detail-tap
				 */
			},

			/**
			 * Life Cycle 
			 */
			created: function() {
				this.events = {
					onDataCellClicked : '_gridCellClicked',
					onScrollToBottom :'_gridScrollToBottom'
				};

				DataLudi.setRootContext('');
				DataLudi.setAssetRoot('../../../images/grid');
			},

			/**
			 * Life Cycle 
			 */
			detached: function() {
				this.clearGrid();
			},

			/**
			 * diyGridId가 변경되었을 경우 Grid meta data 조회 URL이 결정된다.
			 *
			 * @param {String} diyGridId
			 */
			_computeDiyGridMetaUrl: function(diyGridId) {
				return diyGrid ? 'diy_grids/' + diyGridId : null;
			},

			/**
			 * Grid meta data가 변경되었을 경우
			 *
			 * @param {Object} metaData
			 */
			_metaDataChanged: function(metaData) {
				this.config = (!metaData || !metaData.config || metaData.config.length <= 1) ? null :  JSON.parse(metaData.config);
				this.model = (!metaData || !metaData.fields || metaData.fields.length <= 1) ? null : JSON.parse(metaData.fields);
				this.columns = (!metaData || !metaData.columns || metaData.columns.length <= 1) ? null : JSON.parse(metaData.columns);
			},

			/**
			 * grid 구성을 위한 meta data 조회 
			 */
			refreshMeta: function() {
				this.$['resource-meta'].generateRequest();
			},

			/**
			 * grid 구성 후 추가 액션 
			 */
			afterGridInitiated: function() {
				this.grid.footer().setVisible(this.showGridFooter);
				this.fire('things-grid-configured', this.grid);
			}

		});
	</script>
</dom-module>