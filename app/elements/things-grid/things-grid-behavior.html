<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-form/iron-form.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../../bower_components/iron-input/iron-input.html">

<link rel="import" href="../../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../../../bower_components/paper-radio-button/paper-radio-button.html">

<link rel="import" href="../things-combo/things-code-selector.html">
<link rel="import" href="../things-date-picker/things-date-picker.html">
<link rel="import" href="../things-date-picker/things-time-picker.html">
<link rel="import" href="../things-msg-box/things-msgbox-behavior.html">
<link rel="import" href="../things-setting/things-global-behavior.html">
<link rel="import" href="../things-spinner/things-spinner-behavior.html">

<script>

window.Things = window.Things || {};

/**
 * var Things.GridBehavior enables a custom element to be included in an things-grid-behavior
 *
 * @demo ./things-grid/demo/index.html
 */
Things.GridBehaviorImpl = {

	properties: {
		/**
		 * grid mode
		 */
		mode: {
			type: String,
			value: 'canvas'
		},

		/**
		 * total record count
		 */
		totalCount: {
			type: Number,
			value: 0,
			notify: true
		},

		/**
		 * limit record count
		 */
		limit: {
			type: Number,
			value: 50,
			notify: true
		},

		/**
		 * use pagination or not
		 */
		paginatable: {
			type: Boolean,
			value: true
		}

		/**
		 * page record count
		 */
		page: {
			type: Number,
			value: 1,
			notify: true
		},

		/**
		 * grid data model - array of fields
		 */
		modelFields: {
			type: Array,
			observer: '_setGridModelFields'
		},

		/**
		 * grid view column
		 */
		columns: {
			type: Array,
			observer: '_setGridColumns'
		},

		/**
		 * grid header menus
		 */
		headerMenus: {
			type: Array
		},

		/**
		 * root property of loaded data
		 */
		rootProperty: {
			type: String,
			value: ''
		},

		/**
		 * total count property of loaded data
		 */
		totalProperty: {
			type: String,
			value: ''
		},

		/**
		 * read data
		 */
		readData: {
			type: Object,
			observer: '_afterReadGridData'
		},

		/**
		 * grid data set
		 */
		dataSet: {
			type: Object,
			value: function() {
				return DataLudi.createGridDataSet();
			}
		},

		/**
		 * dataludi grid
		 */
		grid: {
			type: Object
		},

		/**
		 * selected grid row
		 */
		selectedRowData: {
			type: Object,
			notify: true,
			readonly: true
		},

		/**
		 * selected grid cell
		 */
		selectedCellData: {
			type: Object,
			notify: true,
			readonly: true
		},

		/**
		 * file name on exporting
		 */
		exportFileName: {
			type: String
		},

		/**
		 * write enabled or not
		 */
		writable: {
			type: Boolean,
			value: true
		},
		
		/**
		 * data to save
		 */
		writeData: {
			type: Array,
			notify: true
		}
	},

	listeners: {
		'iron-resize' : '_onScreenResize',
		'import-btn.tap' : 'importGridData',
		'export-btn.tap' : 'exportGridData',
		'add-btn.tap'    : 'addGridRow',
		'delete-btn.tap' : 'removeGridRow',
		'save-btn.confirm' :'saveGridData',
		'saveResource.response' : '_successSaveHandler'
	},

	/**
	 * configure grid
	 */
	configureGrid: function() {
		if(this.grid == null) {
			this.grid = DataLudi.createGridView('gridContainer', null, false);
			this.grid.setDataSource(this.dataSet);
			this.grid.registerImageList({
				name : "images",
				root : "images/grid/",
				items : [ "iconDetail.png" ]
			});
				
			if(this.modelFields && this.modelFields.length > 0) {
				this._setModelFields(this.fields);
			}

			if(this.columns && this.columns.length > 0) {
				this._setGridColumns(this.columns);
			}

			//register grid event here
			this.registerGridEvent();
		}
	},

	/**
	 * check valid grid configuration
	 */
	validateGridConfig: function() {
		if(this.paginatable) {
			if(!this.rootProperty || !this.totalProperty) {
				return false;
			}
		}

		return true;
	},

	/**
	 * clear all grid informations
	 */
	clearGrid: function() {
		this.readData = null;
		this.writeData = null;
		this.dataSet = null;
		this.model = null;
		this.columns = null;
		this.grid = null;
	},

	/**
	 * set model fields to grid
	 */
	_setGridModelFields: function(fields) {
		if(fields && fields.length > 0 && this.grid) {
			var cudField = { fieldName: "cud_flag_" };
			fields.push(cudField);
			this.dataSet.setFields(fields);
			this.dataSet.setCheckStates(true);
		}
	},

	/**
	 * set grid column views to grid
	 */
	_setGridColumns: function(columns) {
		if(columns && columns.length > 0 && this.grid) {
			var cols = [ {
				'name': 'Detail',
				'width': '25',
				'imageList': 'images',
				'renderer': {
					'type': 'icon'
				},
				'styles': {
					'textAlignment': 'center',
					'iconIndex': 'iconDetail.png',
					'iconLocation': 'center'
				},
				'header': {
					'text': ' '
				}
			} ];

			columns.forEach(function(item) { cols.push(item); });
			this.grid.setColumns(cols);
			this.grid.rowIndicator().setStateVisible(true);
			this.grid.setEditOptions({ deletable: true, insertable: true, appendable: true });
			this.grid.resetSize();
			// this.grid.orderByFields (['ID'],DataLudi.SortDirection.DESCENDING);
		}
	},

	/**
	 * after read data
	 * @param readData
	 */
	_afterReadGridData: function(readData) {
		if(this.dataSet) {
			if(this.paginatable && readData) {
				this.totalCount = readData[this.totalProperty];
			}

			var items = null;					
			if(this.paginatable && readData) {
				items = readData[this.rootProperty];
			} else {
				items = readData;
			}

			this.dataSet.setRows(items);

			if(this.totalCount == 0) {
				this.totalCount = items ? items.length : 0;
			}
		}
	},

	/**
	 * import from excel
	 */
	importGridData: function() {
		// TODO
	},

	/**
	 * export to excel
	 */
	exportGridData: function() {
		var fileName = this.exportFileName;
		new DataLudi.GridExcelExporter().export(this.grid, {
			target: "local",
			fileName: fileName,
			numberFormat: "#,##0.00",
			datetimeFormat: "yyyy.mm.dd"
		});
	},

	/**
	 * remove grid row. 실제 삭제하지 않고 플래그 처리한 후 save시 서버에서 일괄 처리한다.
	 */
	removeGridRow: function() {
		var row = this.grid.focusedRow();
		if (row && row.dataIndex() >= 0) {
			if (this.dataSet.getRowState(row.dataIndex()) == 'created') {
				this.dataSet.setRowState(row.dataIndex(), 'createAndDeleted');
			} else {
				this.dataSet.setRowState(row.dataIndex(), 'deleted');
			}
		}
	},

	/**
	 * add grid row
	 */
	addGridRow:function() {
		var row = Math.max(this.grid.focusedDataIndex(), 0);
		this.dataSet.insertRow(row, {});
	},

	/**
	 * 그리드의 변경된 데이터를 감지하여 서버로 한꺼번에 Create/Update/Delete 요청을 한다.
	 */
	saveGridData: function() {
		var changedDataList = [];

		this._configureChangedData(changedDataList, 'created', 'c');
		this._configureChangedData(changedDataList, 'updated', 'u');
		this._configureChangedData(changedDataList, 'deleted', 'd');

		this.writeData = changedDataList;
		this.$.saveResource.generateRequest();
	},

	/**
	 * 변경 타입(created, updated, deleted)에 따라 변경데이터를 구성한다.
	 */
	_configureChangedData : function(changedData, changeType, changeFlag) {
		var changed = this.dataSet.getStateRows(changeType);
		for (var i = 0; i < changed.length; i++) {
			var changedRow = this.dataSet.getRowObject(inserted[i]);
			changedRow.cud_flag_ = changeFlag;
			changedData.push(object);
		}		
	},

	/**
	 * save 성공시 
	 */
	_successSaveHandler: function() {
		this.fire('things-grid-refresh', this.grid);
	}

};

Things.GridBehavior = [
	Things.GridBehaviorImpl,
	Polymer.IronResizableBehavior,
	Things.GridBehaviorImpl, 
	Things.MsgBoxBehavior
];


</script>