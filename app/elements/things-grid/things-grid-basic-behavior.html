<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../things-id/things-guid-behavior.html">
<link rel="import" href="../things-msg-box/things-msgbox-behavior.html">
<link rel="import" href="../things-setting/things-global-behavior.html">
<link rel="import" href="../things-spinner/things-spinner-behavior.html">
<script src='../../../lib/grid/dataludi.lic.eval-1.2.0.min.js'></script>
<script src='../../../lib/grid/dataludi.eval-1.2.1.min.js'></script>
<script>
window.Things = window.Things || {};

/**
 * var Things.GridBasicBehavior enables a custom element to be included in an things-grid-behavior
 *
 * @demo ./things-grid/demo/index.html
 */
Things.GridBasicBehaviorImpl = {

    properties: {
        /**
         * grid mode
         */
        mode: {
            type: String,
            value: 'canvas'
        },
        /**
         * grid data model - array of fields
         */
        model: {
            type: Array,
            observer: '_setGridModel'
        },

        /**
         * grid view column
         */
        columns: {
            type: Array,
            observer: '_setGridColumns'
        },
        /**
         * config grid
         */
        config: {
            type: Object,
            observer: '_setGridConfig'
        },

        /**
         * read data
         */
        data: {
            type: Object,
            observer: '_afterReadGridData'
        },

        /**
         * 선택된 row data
         */
        selectedRowData: {
            type: Object,
            notify: true,
            readonly: true
        },

        /**
         * 선택된 cell data
         */
        selectedCellData: {
            type: Object,
            notify: true,
            readonly: true
        },
        /**
         * grid container id
         * grid container id가 중복이 되면 grid가 다른 grid container에 생성될 수 있으므로 id는 자동 증가하도록 한다.
         */
        gridContainerId: {
            type: String,
            readonly: true
        },
        /**
         * grid data set
         */
        dataSet: {
            type: Object,
            value: function() {
                return DataLudi.createGridDataSet();
            },
            readonly: true
        },

        /**
         * dataludi grid
         */
        grid: {
            type: Object,
            readonly: true
        }
    },

    listeners: {
        'iron-resize': '_gridScreenResizeHandler'
    },

    /**
     * initial grid
     */
    initialGrid: function() {
        if (this.grid == null) {
            this.gridContainerId = this.generateGuid();
            this.grid = DataLudi.createGridView(this.gridContainerId, null, false);
            this.grid.setDataSource(this.dataSet);
            this.grid.registerImageList({
                name: "images",
                root: "images/grid/",
                items: [
                    "iconDetail.png",
                    "ellipsis_hover.png"
                ]
            });

            this.grid.body().setCellDynamicStyles([{
                expression: 'row % 2',
                styles: {
                    background: '#20006060'
                }
            }]);
        }
    },

    /**
     * clear all grid informations
     */
    clearGrid: function() {
        this.data = null;
        this.dataSet = null;
        this.model = null;
        this.columns = null;

        if (this.grid != null && typeof(this.grid._container_) !== 'undefined') {
            this.grid._container_ = null;
        }

        this.grid = null;
    },

    /**
     * Dataludi 그리드 이벤트를 추가한다.
     * attribute 중에 gridEvent 값이 설정되어 있다면 그것으로 이벤트 핸들러를 등록한다.
     */
    registerGridEvent: function() {
        if (typeof(this.events) !== 'undefined') {
            this.grid._container_ = this;

            for (var eventName in this.gridEvents) {
                this.grid[eventName] = this[this.gridEvents[eventName]];
            }
        }
    },

    /**
     * parentNode 사이즈에 따라 그리드를 resize
     * @param parentNode
     * @param gridContainer
     */
    resizeGrid: function(parentNode, gridContainer) {
        gridContainer.style.width = (parentNode.offsetWidth - 20) + 'px';
        gridContainer.style.height = '300px';
        this.grid.resetSize();
    },

    /**
     * get grid object
     */
    getGridObject : function () {
         return this.grid; 
    },

    /**
     * get grid DataSet
     */
    getGridDataSet : function () {
         return this.dataSet; 
    },

    /**
     * resize handler
     */
    _gridScreenResizeHandler: function(e) {
        if (this.parentNode.offsetWidth > 0 && this.grid == null) {
            this.initialGrid();
        }

        if (this.grid != null && this.grid._container) {
            //this.resizeGrid(this.parentNode, this.grid._container);
            this.resizeGrid(this.parentNode, this.querySelector('div'));
        }
    },

    /**
     * set model fields to grid
     */
    _setGridModel: function(gridModel) {
        if(typeof(gridModel)==='string'){
            gridModel = JSON.parse(gridModel);
        }
        
        if (gridModel && gridModel.length > 0 && this.grid) {
            this.dataSet.setFields(gridModel);
            this.dataSet.setCheckStates(true);
        }
    },

    /**
     * set grid column views to grid
     */
    _setGridColumns: function(columns) {
        if(typeof(columns)==='string'){
            columns = JSON.parse(columns);
        }
        
        if (this.enableDetailColumn) {
            cols = [{
                'name': 'Detail',
                'width': '25',
                'imageList': 'images',
                'renderer': {
                    'type': 'icon'
                },
                'styles': {
                    'textAlignment': 'center',
                    'iconIndex': 'iconDetail.png',
                    'iconLocation': 'center'
                },
                'header': {
                    'text': ' '
                }
            }];

            columns.forEach(function(item) {
                cols.push(item);
            });

        } else {
            cols = columns;
        }

        if (cols && cols.length > 0 && this.grid) {
            this.grid.setColumns(cols);
            this.grid.resetSize();   
        }
    },

    /**
     * set grid initial config information
     */
    _setGridConfig: function(config) {
        var me = this;
        // config = JSON.parse(config);
        if(typeof(config)==='string'){
            config = JSON.parse(config);
        }

        if((typeof config == "undefined" || config == null)&&this.grid){
            this.grid.setEditOptions({
                readOnly : true
            });
            return;
        }

        if(config && this.grid){
			Object.keys(config).forEach(function(objectKey) {
	            switch (objectKey) {
	                case 'body':
	                    me.grid.setBody(config[objectKey]);
	                    break;

	                case 'checkBar':
	                    me.grid.setCheckBar(config[objectKey]);
	                    break;

	                case 'header':
	                    me.grid.setHeader(config[objectKey]);
	                    break;

	                case 'footer':
	                    me.grid.setFooter(config[objectKey]);
	                    break;

	                case 'columnLayout':
	                    me.grid.setColumnLayout(config[objectKey]);
	                    break;

	                case 'dataCellRenderers':
	                    me.grid.dataCellRenderers().addRenderers(config[objectKey]);
	                    break;

	                case 'displayOptions':
	                    me.grid.setDisplayOptions(config[objectKey]);
	                    break;

	                case 'editOptions':
	                    me.grid.setEditOptions(config[objectKey]);
	                    break;

	                case 'summaryMode':
	                	var SummaryMode = DataLudi.SummaryMode[config[objectKey].toUpperCase()];
	                    me.grid.setSummaryMode(SummaryMode);
	                    break;

	                // case 'event':
	                // 	config[objectKey].forEach(function(event){
		               //  	me.gridEvents.push(event);	
	                // 	});
	                // 	me.registerGridEvent();
                 //        break;

	                case 'button':
	                	config[objectKey].forEach(function(button){
		                	me.buttons.push(button);	
	                	});
                        break;

                    case 'rowIndicator':
                        me.grid.rowIndicator().setProperties(config[objectKey]);
                        break;

	                default: break;
	            }
	        });
        }

        if(this.events && this.grid) this.registerGridEvent();

        // grid 구성 후 액션 
        if (this.afterGridConfigured) {
            this.afterGridConfigured();
        }

    },
    /**
     * after read data
     * @param data
     */
    _afterReadGridData: function(data) {
        if (data && this.dataSet) {
            if (!this.grid) {
                this.initialGrid();
                this.resizeGrid(this.parentNode, this.querySelector('div'));
            }

            if (this.appendMode) {
                this.dataSet.appendRows(data, 0, -1, false);
                this.dataSet.clearRowStates();
            } else {
                this.dataSet.setRows(data);
            }
        }
    }

};

Things.GridBasicBehavior = [
    Things.GridBasicBehaviorImpl,
    Polymer.IronResizableBehavior,
    Things.MsgBoxBehavior,
    Things.SpinnerBehavior,
    Things.GUIDBehavior
];
</script>
