<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../things-msg-box/things-msgbox-behavior.html">
<link rel="import" href="./things-grid-basic-behavior.html">

<script src='../../../bower_components/jszip/dist/jszip.min.js'></script>

<script>

window.Things = window.Things || {};

/**
 * 조회, 생성, 삭제, 수정 등의 패턴화된 Resource 서비스를 이용하여 C/R/U/D 기능을 기본으로 제공하는 그리드 Behavior 
 *
 * @demo ./things-grid/demo/demo-things-resource-grid.html
 */
Things.GridResourceBehaviorImpl = {

	properties: {
		/**
		 * write enabled or not
		 */
		writable: {
			type: Boolean,
			value: true
		},

		/**
		 * grid save action url
		 */
		gridSaveAction: {
			type: String
		},

		/**
		 * data to save
		 */
		writeData: {
			type: Array,
			notify: true
		},

		/**
		 * file name to export
		 */
		exportFileName: {
			type: String
		},

		/**
		 * Excel Export시 Sheet Name
		 */
		exportSheetName: {
			type: String
		}
	},

	/**
	 * export to excel
	 */
	exportGridData: function() {
		new DataLudi.GridExcelExporter().export(this.grid, {
			target: "local",
			fileName: this.exportFileName,
			numberFormat: "#,##0.00",
			datetimeFormat: "yyyy.mm.dd"
		});
	},

	/**
	 * remove grid row. 실제 삭제하지 않고 플래그 처리한 후 save시 서버에서 일괄 처리한다.
	 */
	removeGridRow: function() {
		var rows = this.grid.getCheckedRows();
		if (rows && rows.length > 0) {
			var ds = this.dataSet;

			rows.forEach(function(row) {
				if (ds.getRowState(row.dataIndex()) == 'created') {
					ds.setRowState(row.dataIndex(), 'createAndDeleted');
				} else {
					ds.setRowState(row.dataIndex(), 'deleted');
				}
			});
		}
	},

	/**
	 * add grid row
	 */
	addGridRow: function() {
		this.grid.editOptions().setInsertable(true).setAppendable(true);
		this.dataSet.insertRow(0, {});
	},

	/**
	 * 그리드의 변경된 데이터를 감지하여 서버로 한꺼번에 Create/Update/Delete 요청을 한다.
	 */
	saveGridData: function() {
		var changedDataList = [];
		try {
			this.grid.commit();
			this._configureChangedData(changedDataList, 'created', 'c');
			this._configureChangedData(changedDataList, 'updated', 'u');
			this._configureChangedData(changedDataList, 'deleted', 'd');
			this.writeData = changedDataList;
			this._gridSaveAction();
		} catch (err) {
			console.log(err);
			// this.openInfoMsg({
			// 	type : 'warning',
			// 	title : 'Validation Error',
			// 	text : err.message,
			// 	html : false
			// });
			this.showToastMsg(err.message);
		}

	},

	/**
	 * 변경 타입(created, updated, deleted)에 따라 변경데이터를 구성한다.
	 */
	_configureChangedData: function(changedData, changeType, changeFlag) {
		var changed = this.dataSet.getStateRows(changeType);
		for (var i = 0; i < changed.length; i++) {
			var changedRow = this.dataSet.getRowObject(changed[i]);
			changedRow.cud_flag_ = changeFlag;
			changedData.push(changedRow);
		}
	}
};

Things.GridResourceBehavior = [
	Things.GridBasicBehavior,
	Things.GridResourceBehaviorImpl
];
</script>