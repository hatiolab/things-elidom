<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../../../bower_components/paper-toolbar/paper-toolbar.html">

<link rel="import" href="../things-button/things-button.html">
<link rel="import" href="../things-import-excel/things-import-excel-button.html">
<link rel="import" href="../things-paginator/things-paginator.html">

<link rel="import" href="./things-grid-basic-behavior.html">
<link rel="import" href="./things-grid-resource-behavior.html">

<!--
기본 라소스 그리드. Pagination을 지원하고 import, export, add, delete, save가 가능한 그리드

	Example:

    <things-resource 
      auto
      action="diy_services/ElidomGridModel/query.json" 
      last-response="{{gridModel}}">
    </things-resource>

    <things-resource 
      auto
      action="diy_services/ElidomGridColumn/query.json" 
      last-response="{{gridColumns}}">
    </things-resource>

    <things-resource 
      id="search-resource"
      action="terminologies" 
      method="GET"
      content-type="application/json"
      last-response="{{gridData}}">
    </things-resource>

    <things-resource-grid 
      id="grid"
      grid-model="[[gridModel]]" 
      columns="[[gridColumns]]" 
      read-data="[[gridData]]"
      page="{{page}}"
      limit="{{limit}}"
      root-property="items"
      total-property="total"
      selected-row-data="{{selectedRow}}"
      page-start-idx="{{pageStartIdx}}"
      page-end-idx="{{pageEndIdx}}">
    </things-resource-grid>

@demo ./things-grid/demo/demo-things-resource-grid.html
-->

<dom-module id="things-resource-grid">
	<template>
		<style>
			:host {
				display: block;
				height: 100%;
				width: 100%;
				padding: 10px 0px 0px 0px;
			}
		</style>
	
		<div id="{{gridContainerId}}"></div>

		<paper-toolbar id="_gridToolbar" class="white" hidden$="{{infinitable}}">
			<div class="bottom fit">
				<things-paginator 
					per-page="{{limit}}" 
					current-page="{{page}}" 
					total-count="[[totalCount]]"
					page-start-idx="[[pageStartIdx]]"
					page-end-idx="[[pageEndIdx]]">
				</things-paginator>

				<things-import-excel-button 
					color="green" 
					id="import-btn"
					sheet-name="{{exportSheetName}}"
					parsed-result ="{{input}}"
					root-property="[[rootProperty]]"
					total-property="[[totalProperty]]">Import
				</things-import-excel-button>

				<things-button color="green" id="export-btn">Export</things-button>
				<things-button color="green" id="add-btn">Add</things-button>
				<things-button color="pink" id="delete-btn">Delete</things-button>
				<things-button color="indigo" id="save-btn" confirm=true title="Confirm" message="Are you sure to Save?">Save</things-button>

				<things-resource 
					id="save-resource"
					content-type="application/json"
					action="{{gridSaveAction}}" 
					method = "POST"
					params="{{writeData}}">
				</things-resource>				
			</div>
		</paper-toolbar>

	</template>

	<script>
		Polymer({
			is: 'things-resource-grid',

			behaviors: [
				Things.GridResourceBehavior
			],
	
			properties: {
				/**
				 * 핸들링하고자 하는 grid event를 설정한다. { grid event 명 : 'event handler 명' }
				 */
				gridEvents : {
					type: Object,
					value: {
						onDataCellClicked : '_gridCellClicked',
						onScrollToBottom :'_gridScrollToBottom'
					}
				}				
				/**
				 * 그리드 Row Data가 선택되었을 경우 fire
				 *
				 * @event things-grid-row-data-select
				 */
				/**
				 * 그리드 Cell Data가 선택되었을 경우 fire
				 *
				 * @event things-grid-cell-data-select
				 */
				/**
				 * 그리드 데이터 Save(저장/삭제/추가) 액션이 성공했을 경우 fire
				 *
				 * @event things-grid-save-success
				 */
				/**
				 * 그리드 데이터 Save(저장/삭제/추가) 액션시 에러가 발생 했을 경우 fire
				 *
				 * @event things-grid-save-error
				 */
				/**
				 * 그리드 detail이 클릭 되었을 경우 
				 * @event things-grid-detail-tap
				 */
			},

			listeners: {
				'save-resource.response' : '_successSaveHandler',
				'save-resource.error' : '_errorSaveHandler',
			},

			created: function() {
				DataLudi.setRootContext('');
				DataLudi.setAssetRoot('images/grid');
			},

			detached: function() {
				this.clearGrid();
			},

			/**
			 * Dataludi grid cell click 이벤트 핸들러 
			 */
			_gridCellClicked: function(grid, cellData) {
				var thingsGrid = grid._container_;

				if (cellData && cellData.dataColumn() && cellData.getDataIndex(grid) >= 0) {
					var rowIndex = cellData.getDataIndex(grid);
					var colIndex = cellData.dataField();
					var row = grid.focusedRow();

					if (row && row.dataIndex() >= 0) {
						thingsGrid.selectedRowData = row.getRowObject();
						thingsGrid.fire('things-grid-row-data-select', thingsGrid.selectedRowData);
					}

					if(cellData.dataField() >= 0) {
						thingsGrid.selectedCellData = thingsGrid.dataSet.getValue(rowIndex, colIndex);
						thingsGrid.fire('things-grid-cell-data-select', thingsGrid.selectedCellData);
					}
					
					if (cellData.dataField() < 0) {
						thingsGrid.selectedRowData = row.getRowObject();
						thingsGrid.fire('things-grid-detail-tap', thingsGrid.selectedRowData);
					}
				}
			},
			/**
			 * Dataludi grid scroll to bottom event handller 
			 * @return {null}
			 */
			_gridScrollToBottom:function(grid){
				var thingsGrid = grid._container_;
				thingsGrid.page +=1;
			},
			/**
			 * grid save action
			 */
			_gridSaveAction: function() {
				this.$['save-resource'].generateRequest();
			},

			/**
			 * save 성공시 핸들러
			 */
			_successSaveHandler: function() {
				this.fire('things-grid-save-success', this.grid);
			},

			/**
			 * save 실패시 핸들러  
			 */
			_errorSaveHandler: function(e) {
				this.fire('things-grid-save-error', e.detail);
			}

		});
	</script>
</dom-module>