<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../../../bower_components/paper-toolbar/paper-toolbar.html">

<link rel="import" href="../things-button/things-button.html">
<link rel="import" href="../things-button/things-button-group.html">
<link rel="import" href="../things-button/things-button-bar.html">
<link rel="import" href="../things-import-excel/things-import-excel.html">
<link rel="import" href="../things-paginator/things-paginator.html">

<link rel="import" href="../things-grid-behavior/things-grid-config-behavior.html">
<link rel="import" href="../things-grid-behavior/things-grid-event-behavior.html">
<link rel="import" href="../things-grid-behavior/things-grid-export-behavior.html">
<link rel="import" href="../things-grid-behavior/things-grid-import-behavior.html">
<link rel="import" href="../things-grid-behavior/things-grid-save-behavior.html">

<!--
기본 라소스 그리드. Pagination을 지원하고 import, export, add, delete, save가 가능한 그리드

	Example:

    <things-ajax 
      auto
      resource-url="diy_services/ElidomGridModel/query.json" 
      method="GET"
      last-response="{{gridModel}}">
    </things-ajax>

    <things-ajax 
      auto
      resource-url="diy_services/ElidomGridColumn/query.json" 
      method="GET"
      last-response="{{gridColumns}}">
    </things-ajax>

    <things-ajax 
      id="search-resource"
      resource-url="terminologies" 
      resource-action="index"
      last-response="{{gridData}}">
    </things-ajax>

    <things-resource-grid 
      id="grid"
      grid-model="[[gridModel]]" 
      columns="[[gridColumns]]" 
      read-data="[[gridData]]"
      page="{{page}}"
      limit="{{limit}}"
      root-property="items"
      total-property="total"
      selected-row-data="{{selectedRow}}"
      page-start-idx="{{pageStartIdx}}"
      page-end-idx="{{pageEndIdx}}">
    </things-resource-grid>

@demo ./things-grid/demo/demo-things-resource-grid.html
-->

<dom-module id="things-resource-grid">
	<template>
		<style>
			:host {
				display: block;
				height: 100%;
				width: 100%;
			}

			:host paper-material {
				padding: 10px;
			}

			:host paper-toolbar {
				padding: 10px 0px 0px 0px;
			}

			paper-toolbar.white {
				--paper-toolbar-background: white;
				--paper-toolbar-title: {
					font-style: italic;
					font-weight: bold;
				};
			}			
		</style>
	
		<paper-material elevation="1" class="flex">
			<div id="{{gridContainerId}}"></div>
		
			<paper-toolbar
				class="white"
				hidden$="{{!enableToolbar}}">
				<div id="gridToolbar" class="bottom fit">
					<things-paginator
						hidden$="{{!paginatable}}"
						id ="paginator"
						per-page="{{perPage}}" 
						current-page="{{currentPage}}" 
						total-count="[[totalCount]]"
						page-start-idx="[[pageStartIdx]]"
						page-end-idx="[[pageEndIdx]]">
					</things-paginator>

					<things-import-excel id ="excelImport" sheet-name="Sheet1"></things-import-excel>

					<!--things-button-bar id="button-group" buttons="[[buttons]]"></things-button-bar-->

					<things-button-group id="button-group" buttons="[[buttons]]"></things-button-group>

					<things-ajax 
						id="save-resource"
						content-type="application/json"
						resource-url="{{gridSaveAction}}" 
						method = "POST"
						body="{{writeData}}">
					</things-ajax>
				</div>
			</paper-toolbar>
		</paper-material>

	</template>

	<script>
		Polymer({
			is: 'things-resource-grid',

			behaviors: [
				Things.GridConfigBehavior,
				Things.GridEventBehavior,
				Things.GridSaveBehavior,
				Things.GridImportBehavior,
				Things.GridExportBehavior
			],
	
			properties: {
				/**
				 * 핸들링하고자 하는 grid event를 설정한다. { grid event 명 : 'event handler 명' }
				 */
				events : {
					type: Object,
					value: {
						onDataCellClicked : '_gridCellClicked',
						onScrollToBottom :'_gridScrollToBottom'
					}
				},

				/**
				 * 추가할 button 정보
				 */
				buttons : {
					type: Array,
					value: [{
						id: 'export-btn',
						text: 'Export',
						icon: 'icons:swap-vert'
					}, {
						id: 'add-btn',
						text: 'Add',
						icon: 'icons:add'
					}, {
						id: 'delete-btn',
						text: 'Delete',
						icon: 'icons:delete'
					}, {
						id: 'save-btn',
						text: 'Save',
						icon: 'icons:save',
						confirm: true,
						title: 'Confirmation',
						message: 'Are you sure to save?'
					},{
						id: 'import-btn',
						text: 'Import',
						icon: 'icons:file-upload'
					}]
				},

				/**
				 * use page nate or not
				 */
				paginatable: {
					type: Boolean,
					value: false
				},
				
				/**
				 * page limit
				 * @type {Object}
				 */
				perPage: {
					type: Number,
					notify: true
				},
				
				/**
				 * current page
				 */
				currentPage: {
					type: Number,
					notify: true
				},
				
				/**
				 * total data count
				 */
				totalCount: {
					type: Number,
					notify: true
				},

				/**
				 * if enable toolbar or not
				 */
				enableToolbar: {
					type: Boolean,
					value: false
				}
				
				/**
				 * 그리드 Row Data가 선택되었을 경우 fire
				 *
				 * @event things-grid-row-data-select
				 */
				/**
				 * 그리드 Cell Data가 선택되었을 경우 fire
				 *
				 * @event things-grid-cell-data-select
				 */
				/**
				 * 그리드 데이터 Save(저장/삭제/추가) 액션이 성공했을 경우 fire
				 *
				 * @event things-grid-save-success
				 */
				/**
				 * 그리드 데이터 Save(저장/삭제/추가) 액션시 에러가 발생 했을 경우 fire
				 *
				 * @event things-grid-save-error
				 */
				/**
				 * 그리드 detail이 클릭 되었을 경우 
				 * @event things-grid-detail-tap
				 */
			},

			listeners: {
				'save-resource.things-ajax-response' : '_successSaveHandler',
				'save-resource.things-ajax-error' : '_errorSaveHandler',
				'button-group.export-btn-tap' : '_exportGridDataHandler',
				'button-group.add-btn-tap' : '_addGridRowHandler',
				'button-group.delete-btn-tap' : '_removeGridRowHandler',
				'button-group.save-btn-tap' : '_saveGridDataHandler',
				'button-group.import-btn-tap' : '_importExcelHandler'
			},

			/**
			 * Life Cycle - Create
			 */
			created: function() {
				DataLudi.setRootContext('');
				DataLudi.setAssetRoot('images/grid');
			},

			/**
			 * Life Cycle - Detached
			 */
			detached: function() {
				this.clearGrid();
			},

			/**
			 * grid 구성 후 추가 액션, callback으로 function전달
			 */
			afterGridInitiated: function() {
				this.grid.footer().setVisible(false);
				this.fire('things-resource-grid-configured', this.grid);
				
				// header가 ...인 경우 Resource Selector
				var me = this;
				this.grid.onDataCellDblClicked = function (grid, index) {
					var column = index.column;
					if(column._header && column._header._text == '...' && 
						 column._renderer && column._renderer.type && column._renderer.type == 'icon') {
						var matchColumn = me.columns.filter(function(col) { return (column._name == col.name); });
						me.fire('things-grid-resource-column-edit', { 
							userObj : matchColumn ? matchColumn[0].userObj : null, 
							index: index 
						});
					}
				};

				// enableToolbar가 true인 경우 c.u.d 활성화
				if(this.enableToolbar) {
					this.grid.editOptions().setInsertable(true);
					this.grid.editOptions().setAppendable(true);
					this.grid.editOptions().setUpdatable(true);
					this.grid.editOptions().setDeletable(true);
				}
			},

			/**
			 * export
			 */
			_exportGridDataHandler: function(e) {
				var evt = this.fire('things-grid-handle-export', e.detail, { cancelable: true });
				if(!evt.defaultPrevented) this.exportGridData();
			},

			/**
			 * add grid row
			 */
			_addGridRowHandler: function(e) {
				var evt = this.fire('things-grid-handle-addrow', e.detail, { cancelable: true });
				if(!evt.defaultPrevented) this.addGridRow();
			},

			/**
			 * remove grid row
			 */
			_removeGridRowHandler: function(e) {
				var evt = this.fire('things-grid-handle-removerow', e.detail, { cancelable: true });
				if(!evt.defaultPrevented) this.removeGridRow();
			},

			/**
			 * save grid data
			 */
			_saveGridDataHandler: function(e) {
				var evt = this.fire('things-grid-handle-savegrid', e.detail, { cancelable: true });
				if(!evt.defaultPrevented) this.saveGridData();
			},

			/**
			 * import
			 */
			_importExcelHandler: function(e) {
				var evt = this.fire('things-grid-handle-import', e.detail, { cancelable: true });
				if(!evt.defaultPrevented) this.importExcel();
			},			

			/**
			 * TODO Things.GridEventBehavior와 중복 
			 * 
			 * Dataludi grid cell click 이벤트 핸들러 
			 *
			 * @param {Object} grid
			 * @param {Object} cellData
			 */
			_gridCellClicked: function(grid, cellData) {
				if(!grid._container_ || !cellData) return;

				var thingsGrid = grid._container_;

				if (cellData.dataColumn() && cellData.getDataIndex(grid) >= 0) {
					var rowIndex = cellData.getDataIndex(grid);
					var colIndex = cellData.dataField();
					var row = grid.focusedRow();

					if(row && row.dataIndex() >= 0) {
						thingsGrid.selectedRowData = row.getRowObject();
						thingsGrid.fire('things-grid-row-data-select', thingsGrid.selectedRowData);
					}

					if(cellData.dataField() >= 0) {
						if(thingsGrid.dataSet) {
							thingsGrid.selectedCellData = thingsGrid.dataSet.getValue(rowIndex, colIndex);
							thingsGrid.fire('things-grid-cell-data-select', { row : thingsGrid.selectedRowData, cell: cellData });
						}
					}
					
					if(thingsGrid.enableDetailColumn && cellData.column._name == 'Detail' && 
						 cellData.column._renderer && cellData.column._renderer.type == 'icon') {
						thingsGrid.selectedRowData = row.getRowObject();
						thingsGrid.fire('things-grid-detail-tap', thingsGrid.selectedRowData);
					}
				}
			},

			/**
			 * Dataludi grid scroll to bottom event handller 
			 */
			_gridScrollToBottom: function(grid) {
				var thingsGrid = grid._container_;
				if(thingsGrid.totalCount > thingsGrid.pageEndIdx) {
					thingsGrid.page += 1;	
				}				
			},

			/**
			 * grid save action
			 */
			_gridSaveAction: function() {
				// Allow for a presubmit hook
				var event = this.fire('things-grid-pre-save', {}, {cancelable: true});

				if(!event.defaultPrevented) {
					this.$['save-resource'].generateRequest();
				}
			},

			/**
			 * save 성공시 핸들러
			 */
			_successSaveHandler: function() {
				this.fire('things-grid-save-success', this.grid);
			},

			/**
			 * save 실패시 핸들러  
			 */
			_errorSaveHandler: function(e) {
				this.fire('things-grid-save-error', e.detail);
			}

		});
	</script>
</dom-module>