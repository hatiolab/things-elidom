<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../things-paginator/things-paginator.html">
<link rel="import" href="../../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">

<!--
A comment describing this element

Example:

	<my-elem></my-elem>

Example:

	<my-elem>
	  <h2>Hello my-elem</h2>
	</my-elem>

@demo demo/index.html
-->

<dom-module id="things-grid">
	<template>
		<style is="custom-style">
			paper-toolbar.white {
				--paper-toolbar-background: white;
				--paper-toolbar-title: {
					font-style: italic;
					font-weight: bold;
				};
			}
		</style>
		<style>
			:host {
				display: block;
				height: 100%;
				width: 100%;
				padding: 10px 0px 0px 0px;
			}
		</style>
	
		<div id="gridContainer"></div>

		<paper-toolbar class="white">
			<div class="bottom fit">
				<things-paginator per-page="{{limit}}" current-page="{{page}}" total-count="{{totalCount}}"></things-paginator>

				<things-button color="green" id="import-btn">Import</things-button>
				<things-button color="green" id="export-btn">Export</things-button>
				<things-button color="green" id="add-btn">Add</things-button>
				<things-button color="pink" id="delete-btn">Delete</things-button>
				<things-button color="indigo" id="save-btn" confirm=true title="Confirm" message="Are you sure to Save?">Save</things-button>
			</div>				
		</paper-toolbar>
		<things-resource 
			id="saveResource"
			content-type="application/json"
			action="terminologies/update_multiple" 
			method = "post"
			params="{{saveRequest}}">
		</things-resource>
	</template>

	<script src='../../../lib/grid/dataludi.lic.eval-1.2.0.min.js'></script>
	<script src='../../../lib/grid/dataludi.eval-1.2.1.min.js'></script>
	<script src='../../../bower_components/jszip/dist/jszip.min.js'></script>

	<script>
		Polymer({
			is: 'things-grid',

			behaviors: [
				Polymer.IronResizableBehavior
			],
	
			properties: {
				mode: {
					type: String,
					value: 'canvas'
				},

				/**
				 * total record count
				 * @type number
				 */
				totalCount: {
					type: Number,
					value: 0,
					notify: true
				},
				/**
				 * limit record count
				 * @type number
				 */
				limit: {
					type: Number,
					value: 50,
					notify: true
				},
				/**
				 * page record count
				 * @type number
				 */
				page: {
					type: Number,
					value: 1,
					notify: true
				},
				/**
				 * grid data fields
				 * @type Array
				 */
				fields: {
					type: Array,
					observer: 'setFields'
				},

				/**
				 * grid view column
				 * @type {Object}
				 */
				columns: {
					type: Array,
					observer: 'setColumns'
				},

				/**
				 * grid header menus
				 * @type Array
				 */
				headerMenus: {
					type: Array
				},

				/**
				 * loaded data
				 * @type Array
				 */
				input: {
					type: Array,
					observer: 'loadData'
				},

				/**
				 * root property of loaded data
				 * @type String
				 */
				rootProperty: {
					type: String,
					value: ''
				},

				/**
				 * total count property of loaded data
				 * @type String
				 */
				totalProperty: {
					type: String,
					value: ''
				},

				/**
				 * data list for save (new, updated, deleted)
				 * @type Array
				 */
				output: {
					type: Array,
					notify: true
				},

				/**
				 * grid data set
				 * @type Object
				 */
				dataSet: {
					type: Object,
					value: function() {
						return DataLudi.createGridDataSet();
					}
				},

				/**
				 * dataludi grid
				 * @type Object
				 */
				grid: {
					type: Object
				},

				selectedRowData: {
					type: Object,
					notify: true,
					readonly: true
				},

				selectedCellData: {
					type: Object,
					notify: true,
					readonly: true
				},

				exportFileName:{
					type:String
				},
				
				saveRequest:{
					type:Array,
					notify:true
				}
			},

			listeners: {
				'iron-resize': 'onIronResize',
				'import-btn.tap' : 'onImport',
				'export-btn.tap' : 'onExport',
				'add-btn.tap'    : 'onAdd',
				'delete-btn.tap' : 'onDelete',
				'save-btn.tap' :'onSave'
			},

			/**
			 * resize handler
			 */
			onIronResize: function(e) {
				if(this.parentNode.offsetWidth > 0 && this.grid == null) {
					this.grid = DataLudi.createGridView('gridContainer', null, false);
					this.grid.setDataSource(this.dataSet);
					this.grid.registerImageList({
						name: "images",
						root: "images/grid/",
						items: [
							"iconDetail.png"
						]
					});
					
					if(this.fields && this.fields.length > 0) {
						this.setFields(this.fields);
					}

					if(this.columns && this.columns.length > 0) {
						this.setColumns(this.columns);
					}

					//register grid event here
					this.registerGridEvent();
				}

				if(this.grid != null) {
					this.$.gridContainer.style.width = this.parentNode.offsetWidth + 'px';
					this.$.gridContainer.style.height = '300px';
					this.grid.resetSize();
				}
			},
			onImport: function(){

			},
			onExport:function(){
				var fileName = this.exportFileName;
				new DataLudi.GridExcelExporter().export(this.grid, {
					target: "local",
					fileName: fileName,
					numberFormat: "#,##0.00",
					datetimeFormat: "yyyy.mm.dd"
				});
			},
			onDelete:function(){
				var row = this.grid.focusedRow();
				if (row && row.dataIndex() >= 0) {
					if (this.dataSet.getRowState(row.dataIndex()) == 'created') {
						this.dataSet.setRowState(row.dataIndex(), 'createAndDeleted');
					} else {
						this.dataSet.setRowState(row.dataIndex(), 'deleted');
					}
				}
			},
			onAdd:function(){
				var row = Math.max(this.grid.focusedDataIndex(), 0);
				this.dataSet.insertRow(row, {});
			},
			onSave:function(){
				var data = [];

				var inserted = this.dataSet.getStateRows('created');
				for (var i = 0; i < inserted.length; i++) {
					var object = this.dataSet.getRowObject(inserted[i]);
					object.cud_flag_ = 'c';
					data.push(object);
				}

				var updated = this.dataSet.getStateRows('updated');
				for (var i = 0; i < updated.length; i++) {
					var object = this.dataSet.getRowObject(updated[i]);
					object.cud_flag_ = 'u';
					data.push(object);
				}

				var deleted = this.dataSet.getStateRows('deleted');
				for (var i = 0; i < deleted.length; i++) {
					console.log(deleted[i]);
					var object = this.dataSet.getRowObject(deleted[i]);
					object.cud_flag_ = 'd';
					data.push(object);
				}
				this.saveRequest = data;
				console.log(this.saveRequest);
				this.$.saveResource.generateRequest();
				//TODO: ajax.object post
				
			},

			created: function() {
				DataLudi.setRootContext('');
				DataLudi.setAssetRoot('images/grid');
			},

			detached: function() {
				this.output = null;
				this.input = null;
				this.dataSet = null;
				this.fields = null;
				this.columns = null;
				this.grid = null;
			},

			setFields: function(fields) {
				if(fields && fields.length > 0 && this.grid) {
					var cudField = {	
						fieldName: "cud_flag_"
					};
					fields.push(cudField);
					this.dataSet.setFields(fields);
					this.dataSet.setCheckStates(true);
				}
			},

			setColumns: function(columns) {
				if(columns && columns.length > 0 && this.grid) {
					var cols = [ {
						'name': 'Detail',
						'width': '25',
						'imageList': 'images',
						'renderer': {
							'type': 'icon'
						},
						'styles': {
							'textAlignment': 'center',
							'iconIndex': 'iconDetail.png',
							'iconLocation': 'center'
						},
						'header': {
							'text': ' '
						}
					} ];

					columns.forEach(function(item) { cols.push(item); });
					this.grid.setColumns(cols);
					this.grid.rowIndicator().setStateVisible(true);
					this.grid.setEditOptions({
						deletable: true,
						insertable: true,
						appendable: true
					});
					this.grid.resetSize();
					// this.grid.orderByFields (['ID'],DataLudi.SortDirection.DESCENDING);
				}
			},

			/**
			 * data fetch 후 후처리 
			 */
			loadData: function(input) {
				if(this.dataSet) {
					if(this.totalProperty && input) {
						this.totalCount = input[this.totalProperty];
					}

					var items = null;
					
					if(this.rootProperty && input) {
						items = input[this.rootProperty];
					} else {
						items = input;
					}
					
					this.dataSet.setRows(items);

					if(this.totalCount == 0) {
						this.totalCount = items ? items.length : 0;
					}
				}
			},

			/**
			 * register grid event
			 */
			registerGridEvent: function() {
				var me = this;

				this.grid.onDataCellClicked = function (grid, indexObject) {
					if (indexObject && indexObject.dataColumn() && indexObject.getDataIndex(grid) >= 0) {
						var rowIndex = indexObject.getDataIndex(grid);
						var colIndex = indexObject.dataField();
						me.onCellClicked(rowIndex, colIndex, indexObject);
					}
				};
			},

			/**
			 * grid cell click handler
			 * @event on-detail-clicked
			 */
			onCellClicked: function(rowIndex, colIndex, indexObject) {
				var row = this.grid.focusedRow();
				if (row && row.dataIndex() >= 0) {
					this.selectedRowData = row.getRowObject();
				}

				if(indexObject.dataField() < 0) {
					this.onDetailClicked();
				} else {
					this.selectedCellData = this.dataSet.getValue(rowIndex,colIndex);
				}
			},

			/**
			 * on-detail-clicked when data in detail column clicked fire this event
			 * @event on-detail-clicked
			 */
			onDetailClicked: function() {
				this.fire('on-detail-clicked', this.selectedRowData);
			}

		});
	</script>
</dom-module>