<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">

<!--
A comment describing this element

Example:

    <my-elem></my-elem>

Example:

    <my-elem>
      <h2>Hello my-elem</h2>
    </my-elem>

@demo demo/index.html
-->

<dom-module id="things-grid">
	<template>
		<style>
			:host {
				display: block;
				height: 100%;
				width: 100%;
			}
		</style>
	
		<div id="gridContainer"></div>
	</template>

	<script src='../../../lib/grid/dataludi.lic.eval-1.2.0.min.js'></script>
	<script src='../../../lib/grid/dataludi.eval-1.2.1.min.js'></script>

	<script>
		Polymer({
			is: 'things-grid',

			behaviors: [
				Polymer.IronResizableBehavior
			],
	
			properties: {
				mode: {
					type: String,
					value: 'canvas'
				},

				/**
				 * [fields description]
				 * @type {Object}
				 */
				fields: {
					type: Array,
					observer: 'setFields'
				},

				/**
				 * [columns description]
				 * @type {Object}
				 */
				columns: {
					type: Array,
					observer: 'setColumns'
				},

				input: {
					type: Array,
					observer: 'loadData'
				},

				headerMenu: {
					type: Array
				},

				output: {
					type: Array,
					notify: true
				},

				dataSet: {
					type: Object,
					value: function() {
						return DataLudi.createGridDataSet();
					}
				},

				grid: {
					type: Object
				},

				selectedRowData: {
					type: Object,
					notify: true,
					readonly: true
				},

				selectedCellData: {
					type: Object,
					notify: true,
					readonly: true
				}
			},

			listeners: {
				'iron-resize': 'onIronResize'
			},

			onIronResize: function(e) {
				console.log('Parent Node width : ' + this.parentNode.offsetWidth + ', hegith: ' + this.parentNode.offsetHeight);

				if(this.parentNode.offsetWidth > 0 && this.grid == null) {
					this.grid = DataLudi.createGridView('gridContainer', null, false);
					this.grid.setDataSource(this.dataSet);
					this.grid.registerImageList({
						name: "images",
						root: "images/grid/",
						items: [
							"iconDetail.png"
						]
					});
					
					if(this.fields && this.fields.length > 0) {
						this.dataSet.setFields(this.fields);
					}

					if(this.columns && this.columns.length > 0) {
						this.grid.setColumns(this.columns);
					}

					//register grid event here
					this.registerGridEvent();
				}

				if(this.grid != null) {
					this.$.gridContainer.style.width = this.parentNode.offsetWidth + 'px';
					this.$.gridContainer.style.height = '300px';
					this.grid.resetSize();
				}
			},

			created: function() {
				DataLudi.setRootContext('');
				DataLudi.setAssetRoot('images/grid');
			},

			detached: function() {
				this.output = null;
				this.input = null;
				this.dataSet = null;
				this.fields = null;
				this.columns = null;
				this.grid = null;
			},

			setFields: function(fields) {
				if(fields && fields.length > 0 && this.dataSet) {
					this.dataSet.setFields(fields);
				}
			},

			setColumns: function(columns) {
				if(columns && columns.length > 0 && this.grid) {
					var cols= [];
					var detail = {
						'name': 'Detail',
						'width': '25',
						'imageList': 'images',
						'renderer': {
							'type': 'icon'
						},
						'styles': {
							'textAlignment': 'center',
							'iconIndex': 'iconDetail.png',
							'iconLocation': 'center'
						},
						'header': {
							'text': ' '
						}
					};
					columns.forEach(function(item){
						cols.push(item);
					});
					cols.unshift(detail);
					this.grid.setColumns(cols);
					this.grid.resetSize();
					// this.grid.orderByFields (['ID'],DataLudi.SortDirection.DESCENDING);
				}
			},

			loadData: function(input) {
				if(this.dataSet) {
					this.dataSet.setRows(input);
					this.output = input;
				}
			},
			registerGridEvent:function(){
				var me = this;
				//on data clicked
				this.grid.onDataCellClicked = function (grid, index) {
					if (index && index.dataColumn() && index.getDataIndex(grid) >= 0) {
						var rowIndex = index.getDataIndex(grid);
						var colIndex = index.dataField();
						me.onCellClicked(rowIndex,colIndex);
					}
				};
				//
			},
			/**
			 * [onCellClicked description]
			 * @event on-detail-clicked
			 */
			onCellClicked:function(rowIndex,colIndex){
				console.log('onCellClicked');
				if(index.dataField()<0){
					this.onDetailClicked();
				}else{
					this.selectedCellData = this.dataSet.getValue(rowIndex,colIndex);
				}
				
				var row = this.grid.focusedRow();
				if (row && row.dataIndex() >= 0) {
					this.selectedRowData = row.getRowObject();
				}
			},
			/**
			 * on-detail-clicked when data in detail column clicked fire this event
			 * @event on-detail-clicked
			 */
			onDetailClicked:function(){
				this.fire('on-detail-clicked',this.selectedRowData);
			}

		});
	</script>
</dom-module>