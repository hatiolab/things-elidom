<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../things-id/things-guid-behavior.html">
<link rel="import" href="../things-msg-box/things-msgbox-behavior.html">
<link rel="import" href="../things-setting/things-global-behavior.html">
<link rel="import" href="../things-spinner/things-spinner-behavior.html">
<script src='../../../lib/grid/dataludi.lic.eval-1.2.0.min.js'></script>
<script src='../../../lib/grid/dataludi.eval-1.2.1.min.js'></script>
<script>
window.Things = window.Things || {};

/**
 * var Things.GridBasicBehavior enables a custom element to be included in an things-grid-behavior
 *
 * @demo ./things-grid/demo/index.html
 */
Things.GridDiyBehaviorImpl = {

    properties: {
        /**
         * grid container id
         * grid container id가 중복이 되면 grid가 다른 grid container에 생성될 수 있으므로 id는 자동 증가하도록 한다.
         */
        gridContainerId: {
            type: String
        },
        /**
         * grid mode
         */
        mode: {
            type: String,
            value: 'canvas'
        },

        /**
         * total record count
         */
        totalCount: {
            type: Number,
            value: 0
        },

        /**
         * limit record count
         */
        limit: {
            type: Number,
            value: 50,
            notify: true
        },
        /**
         * use infinite pagenation or not
         */
        infinitable: {
            type: Boolean,
            value: false
        },
        /**
         * data-fill-mode : 'set', 'append'
         * @type {Object}
         */
        dataFillMode: {
            type: String,
            value: 'set'
        },
        /**
         * use pagination or not
         */
        paginatable: {
            type: Boolean,
            value: false
        },

        /**
         * page record count
         */
        page: {
            type: Number,
            value: 1,
            notify: true
        },

        /**
         * page start index
         */
        pageStartIdx: {
            type: Number
        },

        /**
         * page end index
         */
        pageEndIdx: {
            type: Number
        },

        /**
         * grid data model - array of fields
         */
        gridModel: {
            type: Array,
            observer: '_setGridModel'
        },

        /**
         * grid view column
         */
        columns: {
            type: Array,
            observer: '_setGridColumns'
        },
        /**
         * config grid
         */
        config: {
            type: Object,
            observer: '_setGridConfig'
        },

        /**
         * grid header menus
         */
        headerMenus: {
            type: Array
        },

        /**
         * root property of loaded data
         */
        rootProperty: {
            type: String,
            value: ''
        },

        /**
         * total count property of loaded data
         */
        totalProperty: {
            type: String,
            value: ''
        },

        /**
         * read data
         */
        readData: {
            type: Object,
            observer: '_afterReadGridData'
        },

        /**
         * grid data set
         */
        dataSet: {
            type: Object,
            value: function() {
                return DataLudi.createGridDataSet();
            }
        },

        /**
         * dataludi grid
         */
        grid: {
            type: Object
        },

        /**
         * enable detail column
         */
        enableDetailColumn: {
            type: Boolean,
            value: true
        },

        /**
         * 선택된 row data
         */
        selectedRowData: {
            type: Object,
            notify: true,
            readonly: true
        },

        /**
         * 선택된 cell data
         */
        selectedCellData: {
            type: Object,
            notify: true,
            readonly: true
        },
        /**
         * enable check box or not in grid
         */
        enableCheckBox: {
            type: Boolean,
            notify: true,
            value: true
        },
        /**
         * readonly
         */
        readonly: {
            type: Boolean,
            value: false
        }
    },

    listeners: {
        'iron-resize': '_gridScreenResizeHandler'
    },

    /**
     * configure grid
     */
    configureGrid: function() {
        if (this.validateGridConfig() && this.grid == null) {
            this.gridContainerId = this.generateGuid();
            this.grid = DataLudi.createGridView(this.gridContainerId, null, false);
            this.grid.setDataSource(this.dataSet);
            this.grid.registerImageList({
                name: "images",
                root: "images/grid/",
                items: [
                    "iconDetail.png",
                    "ellipsis_hover.png"
                ]
            });

            this.grid.body().setCellDynamicStyles([{
                expression: 'row % 2',
                styles: {
                    background: '#20006060'
                }
            }]);

            if (this.gridModel && this.gridModel.length > 0) {
                this._setGridModel(this.gridModel);
            }

            if (this.columns && this.columns.length > 0) {
                this._setGridColumns(this.columns);
            }

            if (this.config && this.config.length > 0) {
                this._setGridConfig(this.columns);
            }

            // grid event 등록 
            this.registerGridEvent();

            // grid 구성 후 액션 
            if (this.afterGridConfigured) {
                this.afterGridConfigured();
            }
        }
    },

    /**
     * check valid grid configuration
     */
    validateGridConfig: function() {
        if (this.paginatable || this.infinitable) {
            if (!this.rootProperty) {
                this.openInfoMsg({
                    type: 'error',
                    title: 'Invalid Grid Configuration!',
                    text: '[root-property] should not be empty if you want to use pagination'
                });
                return false;
            }

            if (!this.totalProperty) {
                this.openInfoMsg({
                    type: 'error',
                    title: 'Invalid Grid Configuration!',
                    text: '[total-property] should not be empty if you want to use pagination'
                });
                return false;
            }
        }

        return true;
    },

    /**
     * clear all grid informations
     */
    clearGrid: function() {
        this.readData = null;
        this.dataSet = null;
        this.model = null;
        this.columns = null;

        if (this.grid != null && typeof(this.grid._container_) !== 'undefined') {
            this.grid._container_ = null;
        }

        this.grid = null;
    },

    /**
     * Dataludi 그리드 이벤트를 추가한다.
     * attribute 중에 gridEvent 값이 설정되어 있다면 그것으로 이벤트 핸들러를 등록한다.
     */
    registerGridEvent: function() {
        if (typeof(this.gridEvents) !== 'undefined') {
            this.grid._container_ = this;

            for (var eventName in this.gridEvents) {
                this.grid[eventName] = this[this.gridEvents[eventName]];
            }
        }
    },

    /**
     * parentNode 사이즈에 따라 그리드를 resize
     * @param parentNode
     * @param gridContainer
     */
    resizeGrid: function(parentNode, gridContainer) {
        gridContainer.style.width = (parentNode.offsetWidth - 20) + 'px';
        gridContainer.style.height = '300px';
        this.grid.resetSize();
    },

    /**
     * resize handler
     */
    _gridScreenResizeHandler: function(e) {
        if (this.parentNode.offsetWidth > 0 && this.grid == null) {
            this.configureGrid();
        }

        if (this.grid != null && this.grid._container) {
            //this.resizeGrid(this.parentNode, this.grid._container);
            this.resizeGrid(this.parentNode, this.querySelector('div'));
        }
    },

    /**
     * set model fields to grid
     */
    _setGridModel: function(gridModel) {
         console.log(gridModel);
         gridModel = JSON.parse(gridModel);
        if (gridModel && gridModel.length > 0 && this.grid) {
            this.dataSet.setFields(gridModel);
            this.dataSet.setCheckStates(true);
        }
    },

    /**
     * set grid column views to grid
     */
    _setGridColumns: function(columns) {
        columns = JSON.parse(columns);
        console.log(columns);
        if (columns && columns.length > 0 && this.grid) {
            var cols = null;

            if (this.enableDetailColumn) {
                cols = [{
                    'name': 'Detail',
                    'width': '25',
                    'imageList': 'images',
                    'renderer': {
                        'type': 'icon'
                    },
                    'styles': {
                        'textAlignment': 'center',
                        'iconIndex': 'iconDetail.png',
                        'iconLocation': 'center'
                    },
                    'header': {
                        'text': ' '
                    }
                }];

                columns.forEach(function(item) {
                    cols.push(item);
                });

            } else {
                cols = columns;
            }
            this.grid.checkBar().setVisible(this.enableCheckBox);
            this.grid.setColumns(cols);
            this.grid.rowIndicator().setStateVisible(true);
            this.grid.resetSize();
            
        }
    },
    /**
     * set grid initial config information
     */
    _setGridConfig: function(config) {
        var me = this;
        config = JSON.parse(config);
        console.log(config);
        if(config && config.length > 0 && this.grid){
			Object.keys(config).forEach(function(objectKey) {
	            switch (objectKey) {
	                case 'body':
	                    me.grid.setBody(config[objectKey]);
	                    break;
	                case 'checkBar':
	                    me.grid.setCheckBar(config[objectKey]);
	                    break;
	                case 'header':
	                    me.grid.setHeader(config[objectKey]);
	                    break;
	                case 'footer':
	                    me.grid.setFooter(config[objectKey]);
	                    break;
	                case 'columnLayout':
	                    me.grid.setColumnLayout(config[objectKey]);
	                    break;
	                case 'dataCellRenderers':
	                    me.grid.dataCellRenderers().addRenderers(config[objectKey]);
	                    break;
	                case 'displayOptions':
	                    me.grid.setDisplayOptions(config[objectKey]);
	                    break;
	                case 'editOptions':
	                    me.grid.setEditOptions(config[objectKey]);
	                    break;
	                case 'summaryMode':
	                	var SummaryMode = DataLudi.SummaryMode[config[objectKey].toUpperCase()];
	                    me.grid.setSummaryMode(SummaryMode);
	                    break;
	                case 'event':
	                	config[objectKey].forEach(function(event){
		                	me.gridEvents.push(event);	
	                	});
	                	me.registerGridEvent();
	                case 'button':
	                	config[objectKey].forEach(function(button){
		                	me.buttons.push(button);	
	                	});
	                default: break;
	            }
	        });
        }

    },
    /**
     * after read data
     * @param readData
     */
    _afterReadGridData: function(readData) {
        if (readData && this.dataSet) {
            if (!this.grid) {
                this.configureGrid();
                this.resizeGrid(this.parentNode, this.querySelector('div'));
            }

            var items = (this.paginatable || this.infinitable) ? readData[this.rootProperty] : readData;
            this.totalCount = (this.paginatable || this.infinitable) ? readData[this.totalProperty] : (items ? items.length : 0);


            if (this.dataFillMode == 'append') {
                this.dataSet.appendRows(items, 0, -1, false);
                this.dataSet.clearRowStates();
                this.dataFillMode = 'set';
            } else {
                this.dataSet.setRows(items);
            }
        }
    }

};

Things.GridDiyBehavior = [
    Things.GridDiyBehaviorImpl,
    Polymer.IronResizableBehavior,
    Things.MsgBoxBehavior,
    Things.SpinnerBehavior,
    Things.GUIDBehavior
];
</script>
