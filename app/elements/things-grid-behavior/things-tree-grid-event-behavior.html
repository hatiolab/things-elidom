<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">

<script>

  window.Things = window.Things || {};

  /**
   * 트리 그리드 이벤트 관련 Behavior
   */
  Things.TreeGridEventBehaviorImpl = {

    properties: {
      
      /**
      * 핸들링하고자 하는 grid event를 설정한다. { grid event 명 : 'event handler 명' }
      */
      events : {
        type: Object,
        value: {
          'onDataCellClicked': '_gridCellClicked',
          'onDataCellDblClicked': '_gridCellDblClicked',
          'onScrollToBottom':'_gridScrollToBottom'
        }
      },

      /**
       * 선택된 row data
       */
      selectedRowData: {
        type: Object,
        notify: true,
        readonly: true
      },

      /**
       * 선택된 cell data
       */
      selectedCellData: {
        type: Object,
        notify: true,
        readonly: true
      }
    },

    listeners: {
      'things-grid-event-configuring' : '_configureGridEvent',
      'iron-resize': '_gridScreenResizeHandler'
    },

    observers: [
      '_gridDataChanged(data)'
    ],    

    /**
     * Dataludi 그리드 이벤트를 추가한다.
     * attribute 중에 Event 값이 설정되어 있다면 그것으로 이벤트 핸들러를 등록한다.
     *
     * @event {Event} e
     */
    _configureGridEvent: function(e) {
      if (this.events) {
        for (var eventName in this.events) {
          this.grid[eventName] = this[this.events[eventName]];
        }
      }
    },

    /**
     * 데이터 변경시
     *
     * @event {Event} e
     */
    _gridDataChanged: function(e) {
      if (!this.grid) {
        this.initializeGrid();
        this.resizeGrid(this.parentNode, this.querySelector('div'));
      }

      if (this.data && this.dataSet) {
        DataLudi.loadJsonData(this.dataSet, data, { rows: '', childRows: 'items' });
      }
    },    

    /**
     * parentNode 사이즈에 따라 그리드를 리사이즈
     *
     * @param {Object} parentNode
     * @param {Object} gridContainer
     */
    resizeGrid: function(parentNode, gridContainer) {
      gridContainer.style.width = (parentNode.offsetWidth - 20) + 'px';
      gridContainer.style.height = this.gridHeight + 'px';
      this.grid.resetSize();
    },    

    /**
     * 화면 리사이즈 시에 ...
     *
     * @event {Event} e
     */
    _gridScreenResizeHandler: function(e) {
      if (this.parentNode.offsetWidth > 0 && this.grid == null) {
        this.initializeGrid();
      }

      if (this.grid != null && this.grid._container) {
        this.resizeGrid(this.parentNode, this.querySelector('div'));
      }
    },

    /**
     * Dataludi Grid Cell Click 이벤트 핸들러 
     *
     * @param {Object} grid
     * @param {Object} cellData
     */
    _gridCellClicked: function(grid, cellData) {
      if(!grid._container_ || !cellData) return;

      var thingsGrid = grid._container_;

      if (cellData.dataColumn() && cellData.getDataIndex(grid) >= 0) {
        var rowIndex = cellData.getDataIndex(grid);
        var colIndex = cellData.dataField();
        var row = grid.focusedRow();

        if(row && row.dataIndex() >= 0) {
          thingsGrid.selectedRowData = row.getRowObject();
          thingsGrid.fire('things-grid-row-data-select', thingsGrid.selectedRowData);
        }

        if(thingsGrid.dataSet && cellData.dataField() >= 0) {
          thingsGrid.selectedCellData = thingsGrid.dataSet.getValue(rowIndex, colIndex);
          thingsGrid.fire('things-grid-cell-data-select', { row: thingsGrid.selectedRowData, cell: cellData });
        }

        if(thingsGrid.enableDetailColumn && cellData.column._name == 'Detail' && 
           cellData.column._renderer && cellData.column._renderer.type == 'icon') {
          thingsGrid.selectedRowData = row.getRowObject();
          thingsGrid.fire('things-grid-detail-tap', thingsGrid.selectedRowData);
        }
      }
    },

    /**
     * Grid Cell Double Click 시
     *
     * @param {Object} grid
     * @param {Object} index
     */
    _gridCellDblClicked: function(grid, index) {
      var me = grid._container_;
      var column = index.column;

      if(column._header && column._header._text == '...' && 
         column._renderer && column._renderer.type && column._renderer.type == 'icon') {
        var matchColumn = me.columns.filter(function(col) { return (column._name == col.name); });
        me.fire('things-grid-resource-column-edit', { 
          userObj : matchColumn ? matchColumn[0].userObj : null, 
          index: index 
        });
      }
    },

    /**
     * 그리드에서 스크롤이 아래로 향했을 경우 
     *
     * @param {Object} grid
     */
    _gridScrollToBottom: function(grid) {
      if(this.infiniteScroll) {
        var thingsGrid = grid._container_;

        if(thingsGrid.totalCount > thingsGrid.pageEndIdx) {
          thingsGrid.page += 1; 
        }
      }
    } 

  };

  Things.TreeGridEventBehavior = [
    Things.TreeGridEventBehaviorImpl,
    Polymer.IronResizableBehavior
  ];

</script>