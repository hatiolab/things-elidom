<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">

<script>

  window.Things = window.Things || {};

  /**
   * 그리드 이벤트 관련 Behavior
   */
  Things.GridEventBehaviorImpl = {

    properties: {
      
      /**
      * 핸들링하고자 하는 grid event를 설정한다. { grid event 명 : 'event handler 명' }
      */
      events : {
        type: Object,
        value: {
          'onDataCellClicked': '_gridCellClicked',
          'onDataCellDblClicked': '_gridCellDblClicked'
        }
      },

      /**
       * 선택된 row data
       */
      selectedRowData: {
        type: Object,
        notify: true,
        readonly: true
      },

      /**
       * 선택된 cell data
       */
      selectedCellData: {
        type: Object,
        notify: true,
        readonly: true
      }
    },

    listeners: {
      'things-grid-configured': '_initializeEventHandler',
      'iron-resize': '_gridScreenResizeHandler'
    },

    observers: [
      '_gridDataChanged(data)'
    ],    

    /**
     * 그리드 구성이 완료된 후 GridEventBehavior를 initialize 한다.
     *
     * @event {Event} things-grid-configured
     */
    _initializeEventHandler: function(e) {
      console.log('things-grid-event-behavior received [things-grid-configured]');

      if (this.grid && this.events) {
        var evt = this.fire('things-grid-event-configure', this.grid, { cancelable: true });
        if(!evt.defaultPrevented) {
          for (var eventName in this.events) {
            this.grid[eventName] = this[this.events[eventName]];
          }

          this.fire('things-grid-event-configured', this.grid);
        }
      }
    },

    /**
     * 데이터 변경 이벤트 핸들러 
     *
     * @event {Event} e
     */
    _gridDataChanged: function(e) {
      var evt = this.fire('things-grid-data-change', this.data, { cancelable: true });
      if(!evt.defaultPrevented && this.data && this.dataSet) {
        this.dataSet.setRows(this.data);
        this.fire('things-grid-data-changed', this.data);
      }
    },    

    /**
     * 화면 리사이즈 시 이벤트 핸들러
     *
     * @event {Event} e
     */
    _gridScreenResizeHandler: function(e) {
      var evt = this.fire('things-grid-resize', this.grid, { cancelable: true });
      if(!evt.defaultPrevented && this.grid != null && this.grid._container) {
        this.resizeGrid(this.parentNode, this.querySelector('div'));
        this.fire('things-grid-resized', this.grid);
      }
    },

    /**
     * Dataludi Grid Cell Click 이벤트 핸들러 
     *
     * @param {Object} grid
     * @param {Object} cellData
     */
    _gridCellClicked: function(grid, cellData) {
      if(!grid._container_ || !cellData) return;

      var thingsGrid = grid._container_;

      if (cellData.dataColumn() && cellData.getDataIndex(grid) >= 0) {
        var rowIndex = cellData.getDataIndex(grid);
        var colIndex = cellData.dataField();
        var row = grid.focusedRow();

        if(row && row.dataIndex() >= 0) {
          thingsGrid.selectedRowData = row.getRowObject();
          thingsGrid.fire('things-grid-row-data-select', thingsGrid.selectedRowData);
        }

        if(thingsGrid.dataSet && cellData.dataField() >= 0) {
          thingsGrid.selectedCellData = thingsGrid.dataSet.getValue(rowIndex, colIndex);
          thingsGrid.fire('things-grid-cell-data-select', { row: thingsGrid.selectedRowData, cell: cellData });
        }

        if(thingsGrid.enableDetailColumn && cellData.column._name == 'Detail' && 
           cellData.column._renderer && cellData.column._renderer.type == 'icon') {
          thingsGrid.selectedRowData = row.getRowObject();
          thingsGrid.fire('things-grid-detail-tap', thingsGrid.selectedRowData);
        }
      }
    },

    /**
     * Grid Cell Double Click 이벤트 핸들러 
     *
     * @param {Object} grid
     * @param {Object} index
     */
    _gridCellDblClicked: function(grid, index) {
      var me = grid._container_;
      var column = index.column;

      if(column._header && column._header._text == '...' && 
         column._renderer && column._renderer.type && column._renderer.type == 'icon') {
        var matchColumn = me.columns.filter(function(col) { return (column._name == col.name); });
        me.fire('things-grid-resource-column-edit', { 
          userObj : matchColumn ? matchColumn[0].userObj : null, 
          index: index 
        });
      }
    } 

  };

  Things.GridEventBehavior = [
    Things.GridEventBehaviorImpl,
    Polymer.IronResizableBehavior
  ];

</script>