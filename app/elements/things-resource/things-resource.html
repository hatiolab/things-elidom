<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="../things-setting/things-global-behavior.html">
<link rel="import" href="../things-spinner/things-spinner-behavior.html">
<link rel="import" href="../things-msg-box/things-msgbox-behavior.html">

<link rel="import" href="./things-resource-search-behavior.html">

<!--Restful Ajax

	Example:

		<things-resource>

		</things-resource>

@demo ./things-resource/demo/demo-things-resource.html-->

<dom-module id="things-resource">
	<template>

		<iron-ajax
			id="_ajax"
			auto="[[auto]]"
			url="[[resourceUrl]]"
			handle-as="[[handleAs]]"
			method="[[method]]"
			content-type="[[contentType]]"
			params="[[params]]"
			loading="{{loading}}"
			with-credentials=[[withCredentials]]
			timeout="[[timeout]]"
			last-request="{{lastRequest}}"
			last-response="{{lastResponse}}"			
			on-response="_successAjaxHandler"
			on-error="_errorAjaxHandler"
			on-loading-changed="_loadingChangeHandler">
		</iron-ajax>

	</template>

	<script>
		Polymer({
			is: 'things-resource',

			properties: {
				/**
				 * resource 대표 URL
				 */
				resource : {
					type: String,
					notify: true,
					value: ''
				},

				/**
				 * action 
				 * 모든 리소스는 아래와 같은 일반 Action을 갖고 있다
				 *
				 * Collection actions : index, update_multiple, imports, export, create
				 * Member Actions : findOne, update, delete(url = :resource/:id), isExist (url=:resource/:id/exist)
				 * 기타 : 일반 액션을 벗어난 Action에 대하여서는 {globals.basicUrl}/{resource}/{action} 형태로 호출한다.				 
				 */
				action : {
					type: String,
					notify: true
				},

				/**
				 * 호출하고자 하는 Ajax Full URL
				 */
				resourceUrl: {
					type: String,
					computed : '_computeResourceUrl(globals.basicUrl, resource, action)'
				},				

				/**
				 * request prameters
				 */
				params: {
					type: String
				},

				/**
				 * When request sent and response not received loading will be true, 
				 * after response received loading will be false.
				 */
				loading: {
					type: Boolean,
					notify: true,
					readOnly : true
				},

				method: {
					type: String
				},

				auto: {
					type: Boolean,
					value: false
				},

				handleAs: {
					type: String,
					value: 'json'
				},

				headers: {
					type: Object,
					value: {}
				},

				contentType: {
					type: String,
					value: null
				},

				withCredentials: {
					type: Boolean,
					value: true
				},

				timeout: {
					type: Number,
					value: 0
				},				

				lastRequest: {
					type: Object,
					value: {}
				},

				/**
				 * data have received on this transaction 
				 */
				lastResponse: {
					type: Object,
					notify : true
				},

				/**
				 * 각 action에 대해서 URL, Method, ContentType에 대한 정보를 매핑한다.
				 */
				actionMap: {
					type: Array,
					value: [
						{ name: 'index', type: 'collection', method: 'GET', contentType: 'application/x-www-form-urlencoded' },
						{ name: 'create', type: 'collection', method: 'POST', contentType: 'application/json' },
						{ name : 'update', type: 'member', method: 'PUT', contentType: 'application/json' },
						{ name : 'delete', type: 'member', method: 'POST', contentType: 'application/x-www-form-urlencoded' },
						{ name : 'find', type: 'member', method: 'GET', contentType: 'application/x-www-form-urlencoded' },
						{ name : 'exist', type: 'member', method: 'GET', contentType: 'application/x-www-form-urlencoded' },
						{ name : 'show_by_name', type: 'etc', method: 'GET', contentType: 'application/x-www-form-urlencoded' },
						{ name : 'update_multiple', type: 'etc', method: 'GET', contentType: 'application/json' },
						{ name : 'imports', type: 'etc', method: 'POST', contentType: '' },
						{ name : 'export', type: 'etc', method: 'GET', contentType: '' }
					]
				}

				/**
				 * ajax 요청이 성공한 경우 fire
				 *
				 * @event things-resource-ajax-success
				 */
				/**
				 * ajax 요청이 실패한 경우 fire
				 *
				 * @event things-resource-ajax-error
				 */
				/**
				 * ajax 요청한 경우 fire
				 *
				 * @event things-resource-ajax-request
				 */
			},

			behaviors: [
				Things.ResourceSearchBehavior,
				Things.GlobalBehavior,
				Things.SpinnerBehavior,
				Things.MsgBoxBehavior
			],

			listeners: {
				'_ajax.request' : '_ajaxRequestHandler'
			},

			/**
			 * auto가 false인 경우 Ajax 요청 
			 */
			generateRequest: function() {
				if(this.contentType && this.contentType.toLowerCase().indexOf('application/json') >= 0) {
					this.$._ajax.body = this.params;
				} else if(!this.contentType || this.contentType.toLowerCase() == 'application/x-www-form-urlencoded') {
					this.$._ajax.params = this.handleRequestParams(this.params);
				}

				this.$._ajax.generateRequest();
			},			

			/**
			 * 실제 Ajax 호출 URL 생성
			 * 
			 * @param  {String} basicUrl basic rest url
			 * @param  {String} resource resource 대표 url
			 * @param  {String} action basic rest url을 제외한 action url
			 * @return {String} 실제 액션 URL
			 */
			_computeResourceUrl : function(basicUrl, resource, action) {
				var mapping = this._actionMapping(action);
				var urlArr = [];

				if(!mapping) {
					urlArr = [basicUrl, resource, action];

				} else {
					this.method = mapping.method;
					this.contentType = mapping.contentType;

					if(mapping.type == 'collection') {
						urlArr = [basicUrl, resource];

					} else if(mapping.type == 'member') {
						urlArr = [basicUrl, resource, ':id'];

					} else {
						urlArr = [basicUrl, resource, action];
					}
				}
				return urlArr.filter(function(e) { return e ? true : false }).join('/');
			},

			/**
			 * action mapping
			 */
			_actionMapping: function(action) {
				for(var i = 0 ; i < this.actionMap.length ; i++) {
					var actionInfo = this.actionMap[i];
					if(actionInfo.name == action.toLowerCase()) {
						return actionInfo;
					}
 				}

				return false;	
			},

			/**
			 * ajax 호출 후 성공 시 핸들러
			 */
			_successAjaxHandler: function(event) {
				this.fire('things-resource-ajax-success', this.lastResponse);

				if(this.method && this.method != 'GET') {
					// this.openInfoMsg('Success');
					// app.$.thingsHeader.toggleSidebar();
				}
			},

			/**
			 * ajax 호출 후 실패 시 핸들러
			 */
			_errorAjaxHandler: function(event) {
				if(event && event.detail && 
				   event.detail.request && 
				   event.detail.request.xhr && 
				   event.detail.request.xhr.response) {

					var response = event.detail.request.xhr.response;				   	
					if(response.status == 401) {
						this.handleUnauthorized();
					} else {
						this.openResponseError(response);
					}

					this.fire('things-resource-ajax-error', event.detail.request.xhr.response);

				} else {
					this.openUnkownError(response);
					this.fire('things-resource-ajax-error', event);
				}
			},

			/**
			 * ajax 호출 시 핸들러
			 */
			_ajaxRequestHandler: function(e) {
				var newParams = null;

				if((!this.method || this.method.toLowerCase() == 'get') && (!this.action || this.action == 'index')) {
					newParams = this.handleRequestParams(this.params);
				} else {
					if(this.params) newParams = this.params;
				} 

				if(!(this.contentType && this.contentType.toLowerCase().indexOf('application/json') >= 0)) {
					this.$._ajax.params = newParams;
				}

				// :id 실제 id로 변환 
				if(this.$._ajax.url && this.$._ajax.url.indexOf(':id') >= 0) {
					this.$._ajax.url = this.$._ajax.url.replace(':id', this.params.id);
				}
			},

			/**
			 * Loading 정보 변경시 핸들러 
			 */
			_loadingChangeHandler: function(e) {
				if(e.detail) {
					if(e.detail.value === false) {
						this.stopSpinner();
					} else if(e.detail.value === true) {
						this.startSpinner();
					}
				}
			},
			/**
			* ajax 호출 후 에러 발생시 unauthorized 에러이면 로그인 페이지로 이동 
			*/
			handleUnauthorized: function() {
				this.set('globals.user', null);
				if(app.$.thingsHeader){
				  app.$.thingsHeader.toggleSidebar(); 
				}
				page('/login');
			},
			
		});
	</script>
</dom-module>